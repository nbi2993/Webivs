<!-- FILE: /public/components/header.html -->
<!-- VERSION: 2.8 - Fixed Mobile Language Dropdown Display -->
<!-- DESCRIPTION: Optimized HTML structure for the main header with updated navigation menus and modern aesthetics. -->

<header id="ivs-main-header" class="fixed top-0 left-0 right-0 z-40 bg-ivs-bg transition-all duration-300 ease-in-out">
    <div class="max-w-7xl mx-auto px-4 h-16 md:h-20 flex items-center justify-between">
        <a href="/index.html" class="flex-shrink-0 flex items-center space-x-2 group">
            <img src="/images/logo/logo.png" alt="IVS JSC Logo" class="h-10 md:h-12 w-auto object-contain transition-transform duration-300 group-hover:scale-110" onerror="this.onerror=null; this.src='https://placehold.co/48x48/1f2937/ffffff?text=IVS';">
            <span class="hidden sm:inline text-xl md:text-2xl font-bold group-hover:text-ivs-accent transition-colors">IVS <span class="text-ivs-accent">JSC</span></span>
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden md:flex items-center space-x-2" role="navigation" aria-label="Main navigation">
            <a href="/index.html" class="desktop-nav-link group" data-lang-key="nav_home">
                <i class="fas fa-home mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Trang Chủ
            </a>
            <a href="/about.html" class="desktop-nav-link group" data-lang-key="nav_about">
                <i class="fas fa-info-circle mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Về IVS
            </a>
            
            <div class="desktop-dropdown-container group">
                <button type="button" class="desktop-nav-dropdown-toggle group-hover:text-ivs-accent transition-colors" aria-haspopup="true">
                    <i class="fas fa-th-large mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span data-lang-key="nav_services">Dịch Vụ</span><i class="fas fa-chevron-down text-xs ml-2 group-hover:text-ivs-accent transition-transform group-hover:rotate-180"></i>
                </button>
                <div class="desktop-mega-menu left-1/2 -translate-x-1/2">
                    <div class="grid grid-cols-2 gap-x-6 p-5">
                        <!-- Cột trái: Liên kết Giáo dục -->
                        <div class="space-y-2">
                            <h3 class="font-bold text-ivs-accent border-b border-ivs-border pb-2 mb-2" data-lang-key="nav_services_education_title">Liên kết Giáo dục</h3>
                            <a href="/consulting.html" class="dropdown-item" data-lang-key="nav_services_education_overview"><i class="fas fa-school fa-fw mr-3 text-ivs-accent/70"></i>Tổng quan</a>
                            <a href="/Pages/lkmamnon.html" class="dropdown-item" data-lang-key="nav_services_education_kindergarten"><i class="fas fa-child fa-fw mr-3 text-ivs-accent/70"></i>Liên kết Mầm non</a>
                            <a href="/Pages/lktieuhoc.html" class="dropdown-item" data-lang-key="nav_services_education_primary"><i class="fas fa-book-reader fa-fw mr-3 text-ivs-accent/70"></i>Liên kết Tiểu học</a>
                            <a href="/Pages/lkthcsthpt.html" class="dropdown-item" data-lang-key="nav_services_education_secondary_high"><i class="fas fa-user-graduate fa-fw mr-3 text-ivs-accent/70"></i>Liên kết THCS & THPT</a>
                            <a href="/Pages/lkttnn.html" class="dropdown-item" data-lang-key="nav_services_education_language_centers"><i class="fas fa-language fa-fw mr-3 text-ivs-accent/70"></i>Liên kết Trung tâm Ngoại ngữ</a>
                            <a href="/Pages/foreign-teacher-services.html" class="dropdown-item" data-lang-key="nav_services_education_supply"><i class="fas fa-chalkboard-teacher fa-fw mr-3 text-ivs-accent/70"></i>Cung ứng Giáo viên</a>
                        </div>
                        <!-- Cột phải: Tư vấn Pháp lý -->
                        <div class="space-y-2">
                            <h3 class="font-bold text-ivs-accent border-b border-ivs-border pb-2 mb-2" data-lang-key="nav_services_legal_title">Tư vấn Pháp lý</h3>
                            <a href="/Pages/legal_consulting.html" class="dropdown-item" data-lang-key="nav_services_legal_consulting"><i class="fas fa-gavel fa-fw mr-3 text-ivs-accent/70"></i>Tư vấn Chuyên sâu</a>
                            <a href="/Pages/psb_introduction.html" class="dropdown-item" data-lang-key="nav_services_legal_corporate"><i class="fas fa-balance-scale fa-fw mr-3 text-ivs-accent/70"></i>Luật Doanh nghiệp</a>
                            <a href="/Pages/litigation_consulting.html" class="dropdown-item" data-lang-key="nav_services_legal_civil"><i class="fas fa-landmark fa-fw mr-3 text-ivs-accent/70"></i>Pháp luật Dân sự</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="desktop-dropdown-container group">
                <button type="button" class="desktop-nav-dropdown-toggle group-hover:text-ivs-accent transition-colors" aria-haspopup="true">
                    <i class="fas fa-lightbulb mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span data-lang-key="nav_solutions">Giải pháp</span><i class="fas fa-chevron-down text-xs ml-2 group-hover:text-ivs-accent transition-transform group-hover:rotate-180"></i>
                </button>
                <div class="desktop-dropdown left-1/2 -translate-x-1/2 p-2 space-y-1">
                    <a href="/solutions.html" class="dropdown-item" data-lang-key="nav_solutions_overview">Tổng quan</a>
                    <a href="/Pages/ivscelestech.html" class="dropdown-item" data-lang-key="nav_solutions_edtech">Công nghệ GD</a>
                    <a href="/Pages/upskill.html" class="dropdown-item" data-lang-key="nav_solutions_upskill">Nâng cao Trình độ</a>
                    <a href="/Pages/webdesign.html" class="dropdown-item" data-lang-key="nav_solutions_webdesign">Thiết kế Web</a>
                </div>
            </div>

            <div class="desktop-dropdown-container group">
                <button type="button" class="desktop-nav-dropdown-toggle group-hover:text-ivs-accent transition-colors" aria-haspopup="true">
                    <i class="fas fa-book-open mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span data-lang-key="nav_library">Thư Viện</span><i class="fas fa-chevron-down text-xs ml-2 group-hover:text-ivs-accent transition-transform group-hover:rotate-180"></i>
                </button>
                <div class="desktop-dropdown left-1/2 -translate-x-1/2 p-2 space-y-1">
                    <a href="/gallery.html" class="dropdown-item" data-lang-key="nav_library_gallery">Thư viện Ảnh</a>
                    <a href="/Pages/document-library.html" class="dropdown-item" data-lang-key="nav_library_docs">Tài liệu</a>
                    <a href="/apps/story-repository.html" class="dropdown-item" data-lang-key="nav_library_stories">Kho truyện</a>
                    <a href="/games/ivsgames.html" class="dropdown-item" data-lang-key="nav_library_games">IVS Games</a>
                </div>
            </div>

            <a href="/news-archive.html" class="desktop-nav-link group" data-lang-key="nav_news">
                <i class="fas fa-newspaper mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Tin tức
            </a>
            <a href="/contact.html" class="desktop-nav-link bg-ivs-accent hover:bg-ivs-accent-dark text-white font-bold px-4 py-2 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105" data-lang-key="nav_contact">
                <i class="fas fa-envelope mr-2"></i> Liên Hệ
            </a>
            
            <!-- Added Login Button for Desktop -->
            <a href="/auth.html" class="desktop-nav-link bg-ivs-blue hover:bg-ivs-blue-darker text-white font-bold px-4 py-2 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105" data-lang-key="nav_login">
                <i class="fas fa-user-circle mr-2"></i> Đăng nhập
            </a>

            <div class="desktop-dropdown-container group">
                <button type="button" class="desktop-nav-dropdown-toggle group-hover:text-ivs-accent transition-colors" aria-haspopup="true">
                    <i class="fas fa-globe mr-2 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span id="current-lang-desktop" class="mx-1">VI</span>
                    <i class="fas fa-chevron-down text-xs ml-1 group-hover:text-ivs-accent transition-transform group-hover:rotate-180"></i>
                </button>
                <div class="desktop-dropdown right-0 left-auto -translate-x-0 p-2 space-y-1">
                    <button class="dropdown-item lang-option" data-lang="vi" data-lang-key="lang_vi">
                        <img src="/images/flags/vn.png" alt="Vietnamese Flag" class="h-4 w-6 mr-3 rounded-sm" onerror="this.style.display='none'">Tiếng Việt
                    </button>
                    <button class="dropdown-item lang-option" data-lang="en" data-lang-key="lang_en">
                        <img src="/images/flags/en.png" alt="English Flag" class="h-4 w-6 mr-3 rounded-sm" onerror="this.style.display='none'">English
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Language Selector & Menu Button -->
        <div class="flex items-center md:hidden space-x-2">
            <div id="mobile-lang-dropdown-container" class="relative"> <!-- Added ID for easier targeting -->
                <button type="button" id="mobile-lang-toggle" class="p-2 rounded-lg text-ivs-text-primary hover:bg-ivs-bg-light transition-colors" aria-haspopup="true" aria-expanded="false" aria-controls="mobile-lang-dropdown-content">
                    <i class="fas fa-globe text-xl"></i>
                    <span id="current-lang-mobile" class="ml-1 mr-1 text-sm font-semibold">VI</span>
                    <i class="fas fa-chevron-down text-xs transition-transform duration-300" id="mobile-lang-arrow-icon"></i>
                </button>
                <div id="mobile-lang-dropdown-content" class="absolute top-full right-0 mt-2 p-2 space-y-1 bg-ivs-card border border-ivs-border rounded-lg shadow-xl hidden opacity-0 translate-y-[-10px] transition-all duration-200 ease-out transform origin-top-right">
                    <button class="dropdown-item lang-option" data-lang="vi" data-lang-key="lang_vi">
                        <img src="/images/flags/vn.png" alt="Vietnamese Flag" class="h-4 w-6 mr-3 rounded-sm" onerror="this.style.display='none'">Tiếng Việt
                    </button>
                    <button class="dropdown-item lang-option" data-lang="en" data-lang-key="lang_en">
                        <img src="/images/flags/en.png" alt="English Flag" class="h-4 w-6 mr-3 rounded-sm" onerror="this.style.display='none'">English
                    </button>
                </div>
            </div>
            
            <button id="mobile-menu-open-btn" type="button" class="p-2 rounded-lg text-ivs-text-primary hover:bg-ivs-bg-light transition-colors" aria-label="Open menu" aria-controls="ivs-mobile-menu-panel">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
    </div>
</header>

<!-- Mobile Menu Panel -->
<div id="ivs-mobile-menu-panel" class="fixed inset-0 z-50 md:hidden transition-all duration-300 ease-in-out" aria-modal="true" role="dialog">
    <div id="ivs-mobile-menu-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300"></div>
    <div id="ivs-mobile-menu-container" class="relative w-full max-w-sm h-full bg-ivs-bg-medium ml-auto flex flex-col shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex items-center justify-between p-4 border-b border-ivs-border">
            <span class="text-lg font-semibold text-ivs-accent" data-lang-key="mobile_menu_title">Menu</span>
            <button id="mobile-menu-close-btn" type="button" class="p-2 rounded-lg text-ivs-text-primary hover:bg-ivs-bg-light" aria-label="Close menu">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <nav id="ivs-mobile-main-nav" class="flex-grow p-4 space-y-2 overflow-y-auto custom-scrollbar">
            <a href="/index.html" class="mobile-nav-link group" data-lang-key="nav_home">
                <i class="fas fa-home mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Trang Chủ
            </a>
            <a href="/about.html" class="mobile-nav-link group" data-lang-key="nav_about">
                <i class="fas fa-info-circle mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Về IVS
            </a>
            
            <!-- Mobile Services Menu - NOW NESTED -->
            <div>
                <button class="mobile-submenu-toggle group">
                    <i class="fas fa-th-large mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span data-lang-key="nav_services">Dịch Vụ</span><i class="fas fa-chevron-down mobile-submenu-icon ml-auto group-hover:text-ivs-accent transition-transform"></i>
                </button>
                <div class="mobile-submenu-content space-y-1">
                    <!-- Nested Submenu for Education Links -->
                    <div>
                        <button class="mobile-submenu-toggle nested-level group">
                            <i class="fas fa-school fa-fw mr-3 text-ivs-accent/70"></i>
                            <span data-lang-key="nav_services_education_title">Liên kết Giáo dục</span><i class="fas fa-chevron-down mobile-submenu-icon ml-auto group-hover:text-ivs-accent transition-transform"></i>
                        </button>
                        <div class="mobile-submenu-content nested-level-content space-y-1" style="padding-left: 1.5rem;">
                            <a href="/consulting.html" class="mobile-submenu-item" data-lang-key="nav_services_education_overview">Tổng quan</a>
                            <a href="/Pages/lkmamnon.html" class="mobile-submenu-item" data-lang-key="nav_services_education_kindergarten">Liên kết Mầm non</a>
                            <a href="/Pages/lktieuhoc.html" class="mobile-submenu-item" data-lang-key="nav_services_education_primary">Liên kết Tiểu học</a>
                            <a href="/Pages/lkthcsthpt.html" class="mobile-submenu-item" data-lang-key="nav_services_education_secondary_high">Liên kết THCS & THPT</a>
                            <a href="/Pages/lkttnn.html" class="mobile-submenu-item" data-lang-key="nav_services_education_language_centers">Liên kết Trung tâm Ngoại ngữ</a>
                            <a href="/Pages/foreign-teacher-services.html" class="mobile-submenu-item" data-lang-key="nav_services_education_supply">Cung ứng Giáo viên</a>
                        </div>
                    </div>
                    <!-- Nested Submenu for Legal Consulting -->
                    <div>
                        <button class="mobile-submenu-toggle nested-level group">
                            <i class="fas fa-gavel fa-fw mr-3 text-ivs-accent/70"></i>
                            <span data-lang-key="nav_services_legal_title">Tư vấn Pháp lý</span><i class="fas fa-chevron-down mobile-submenu-icon ml-auto group-hover:text-ivs-accent transition-transform"></i>
                        </button>
                        <div class="mobile-submenu-content nested-level-content space-y-1" style="padding-left: 1.5rem;">
                            <a href="/Pages/legal_consulting.html" class="mobile-submenu-item" data-lang-key="nav_services_legal_consulting">Tư vấn Chuyên sâu</a>
                            <a href="/Pages/psb_introduction.html" class="mobile-submenu-item" data-lang-key="nav_services_legal_corporate">Luật Doanh nghiệp</a>
                            <a href="/Pages/litigation_consulting.html" class="mobile-submenu-item" data-lang-key="nav_services_legal_civil">Pháp luật Dân sự</a>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <button class="mobile-submenu-toggle group">
                    <i class="fas fa-lightbulb mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span data-lang-key="nav_solutions">Giải pháp</span><i class="fas fa-chevron-down mobile-submenu-icon ml-auto group-hover:text-ivs-accent transition-transform"></i>
                </button>
                <div class="mobile-submenu-content space-y-1">
                    <a href="/solutions.html" class="mobile-submenu-item" data-lang-key="nav_solutions_overview">Tổng quan</a>
                    <a href="/Pages/ivscelestech.html" class="mobile-submenu-item" data-lang-key="nav_solutions_edtech">Công nghệ GD</a>
                    <a href="/Pages/upskill.html" class="mobile-submenu-item" data-lang-key="nav_solutions_upskill">Nâng cao Trình độ</a>
                    <a href="/Pages/webdesign.html" class="mobile-submenu-item" data-lang-key="nav_solutions_webdesign">Thiết kế Web</a>
                </div>
            </div>

            <div>
                <button class="mobile-submenu-toggle group">
                    <i class="fas fa-book-open mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i>
                    <span data-lang-key="nav_library">Thư Viện</span><i class="fas fa-chevron-down mobile-submenu-icon ml-auto group-hover:text-ivs-accent transition-transform"></i>
                </button>
                <div class="mobile-submenu-content space-y-1">
                    <a href="/gallery.html" class="mobile-submenu-item" data-lang-key="nav_library_gallery">Thư viện Ảnh</a>
                    <a href="/Pages/document-library.html" class="mobile-submenu-item" data-lang-key="nav_library_docs">Tài liệu</a>
                    <a href="/apps/story-repository.html" class="mobile-submenu-item" data-lang-key="nav_library_stories">Kho truyện</a>
                    <a href="/games/ivsgames.html" class="mobile-submenu-item" data-lang-key="nav_library_games">IVS Games</a>
                </div>
            </div>

            <a href="/news-archive.html" class="mobile-nav-link group" data-lang-key="nav_news">
                <i class="fas fa-newspaper mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Tin tức
            </a>
            <a href="/contact.html" class="mobile-nav-link group" data-lang-key="nav_contact">
                <i class="fas fa-envelope mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Liên Hệ
            </a>
            
            <!-- Added Login Button for Mobile Menu -->
            <a href="/auth.html" class="mobile-nav-link group" data-lang-key="nav_login">
                <i class="fas fa-user-circle mr-3 text-ivs-text-secondary group-hover:text-ivs-accent transition-colors"></i> Đăng nhập
            </a>
        </nav>
    </div>
</div>

<!-- Bottom Navigation for Mobile -->
<nav id="ivs-bottom-nav" class="fixed bottom-0 left-0 right-0 z-30 h-[var(--bottom-nav-height)] flex justify-around items-stretch md:hidden shadow-lg">
    <a href="/index.html" class="bottom-nav-item">
        <i class="fas fa-home text-xl"></i><span class="bottom-nav-text" data-lang-key="bottom_nav_home">Home</span>
    </a>
    <a href="/news-archive.html" class="bottom-nav-item">
        <i class="fas fa-newspaper text-xl"></i><span class="bottom-nav-text" data-lang-key="bottom_nav_news">News</span>
    </a>
    <a href="https://ivsacademy.edu.vn/consulting.html" class="bottom-nav-item" data-lang-key="bottom_nav_services">
        <i class="fas fa-handshake text-xl"></i><span class="bottom-nav-text">Service</span>
    </a>
    <button id="bottom-nav-menu-btn" class="bottom-nav-item">
        <i class="fas fa-bars text-xl"></i><span class="bottom-nav-text" data-lang-key="bottom_nav_menu">Menu</span>
    </button>
</nav>

<!-- Inline styles for component-specific CSS -->
<!-- It's recommended to move these to a central CSS file for production -->
<style>
    :root {
        --header-height: 64px;
        --desktop-header-height: 72px;
        --bottom-nav-height: 60px;
        --ivs-bg: #0D1117; /* Dark background */
        --ivs-card: #161B22; /* Card background */
        --ivs-border: #30363d; /* Border color */
        --ivs-text-primary: #e6edf3; /* Primary text color */
        --ivs-text-secondary: #a1aab4; /* Secondary text color */
        --ivs-accent: #F97316; /* Accent color (Orange) */
        --ivs-accent-dark: #ea580c; /* Darker accent color */
        --ivs-blue: #58a6ff; /* Blue color */
        --ivs-blue-darker: #3b82f6; /* Darker blue */
        --ivs-green: #34d399; /* Green color */
        --ivs-purple: #a78bfa; /* Purple color */
        --ivs-red: #f87171; /* Red color */
        --ivs-cyan: #22d3ee; /* Cyan color */
        --ivs-amber: #f59e0b; /* Amber color */
        --ivs-emerald: #34d399; /* Emerald color */
        --ivs-rose: #f43f5e; /* Rose color */
        --ivs-bg-dark: #111827; /* Used for mobile menu container */
        --ivs-bg-medium: #1f2937; /* Used for mobile menu panel */
        --ivs-bg-light: #374151; /* Used for hover states */
        --ivs-link-active-bg: rgba(249, 115, 22, 0.15); /* Accent with opacity */
    }

    #ivs-main-header.scrolled {
        background-color: rgba(13, 17, 23, 0.9); /* ivs-bg with opacity */
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid var(--ivs-border);
    }
    
    .desktop-nav-link, .desktop-nav-dropdown-toggle {
        display: inline-flex; align-items: center; padding: 10px 15px; /* Increased padding */
        font-size: 1rem; font-weight: 500; color: var(--ivs-text-secondary);
        border-radius: 0.5rem; /* More rounded */
        transition: color 0.2s, background-color 0.2s, transform 0.2s; /* Added transform */
        position: relative; /* For underline effect */
    }
    .desktop-nav-link:hover, .desktop-nav-dropdown-toggle:hover {
        color: var(--ivs-text-primary);
        background-color: var(--ivs-bg-light);
        transform: translateY(-2px); /* Slight lift on hover */
    }
    .desktop-nav-link.active {
        color: var(--ivs-accent); font-weight: 600;
        background-color: var(--ivs-link-active-bg);
        transform: translateY(-2px); /* Maintain lift */
    }
    /* Modern underline effect on hover/active */
    .desktop-nav-link::after, .desktop-nav-dropdown-toggle::after {
        content: '';
        position: absolute;
        bottom: 5px; /* Adjust based on padding */
        left: 50%;
        width: 0;
        height: 2px;
        background-color: var(--ivs-accent);
        transition: width 0.3s ease-in-out, left 0.3s ease-in-out;
    }
    .desktop-nav-link:hover::after, .desktop-nav-link.active::after,
    .desktop-nav-dropdown-toggle:hover::after, .desktop-nav-dropdown-toggle.active::after {
        width: calc(100% - 30px); /* Adjust based on padding */
        left: 15px; /* Match padding-left */
    }


    .desktop-dropdown-container { position: relative; }
    .desktop-dropdown, .desktop-mega-menu {
        position: absolute; top: 100%; left: 0; z-index: 50;
        background-color: var(--ivs-card); /* Darker background for dropdown */
        border: 1px solid var(--ivs-border); border-radius: 0.75rem; /* More rounded */
        box-shadow: 0 15px 30px -5px rgba(0,0,0,0.4); /* Stronger shadow */
        margin-top: 10px; /* More spacing */
        opacity: 0; visibility: hidden;
        transform: translateY(-15px) scale(0.95); /* Deeper animation */
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0.3s;
    }
    .desktop-dropdown-container:hover .desktop-dropdown,
    .desktop-dropdown-container:hover .desktop-mega-menu {
        opacity: 1; visibility: visible;
        transform: translateY(0) scale(1);
        transition-delay: 0s;
    }

    .desktop-dropdown { width: 280px; } /* Slightly wider */
    .desktop-mega-menu { width: 600px; } /* Wider for mega menu */

    .dropdown-item {
        display: flex; align-items: center; width: 100%; text-align: left;
        padding: 12px 18px; /* More padding */
        font-size: 0.95rem; /* Slightly larger text */
        color: var(--ivs-text-secondary);
        border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s, transform 0.2s;
    }
    .dropdown-item:hover {
        background-color: var(--ivs-bg-light); color: var(--ivs-text-primary);
        transform: translateX(5px); /* Slide effect */
    }
    
    #ivs-mobile-menu-panel { 
        visibility: hidden; 
        /* Ensure it's off-screen initially */
        transform: translateX(100%); 
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #ivs-mobile-menu-panel.is-open { 
        visibility: visible; 
        transform: translateX(0);
    }
    #ivs-mobile-menu-backdrop {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    #ivs-mobile-menu-panel.is-open #ivs-mobile-menu-backdrop { opacity: 1; }
    /* #ivs-mobile-menu-container no longer needs transform property here as it's controlled by is-open on panel */

    .mobile-submenu-content {
        max-height: 0; /* Reset max-height */
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        padding-left: 1rem;
    }
    /* Add extra padding for nested mobile submenu content */
    .mobile-submenu-content.nested-level-content {
        padding-left: 2.5rem; /* Increase padding for nested items */
    }
    
    .mobile-submenu-toggle { /* Style for mobile submenu toggle buttons */
        display: flex; justify-content: space-between; align-items: center;
        width: 100%; padding: 10px 15px; /* More padding */
        font-weight: 500; font-size: 1rem; /* Larger text */
        color: var(--ivs-text-secondary); border-radius: 0.5rem;
        transition: background-color 0.2s, color 0.2s;
        text-align: left;
    }

    .mobile-submenu-toggle:hover {
        background-color: var(--ivs-bg-light); color: var(--ivs-text-primary);
    }
    /* Style for nested mobile submenu toggle buttons */
    .mobile-submenu-toggle.nested-level {
        padding: 8px 15px; /* Slightly less padding for nested level */
        font-size: 0.95rem;
    }


    .mobile-submenu-icon {
        transition: transform 0.3s ease;
    }
    .mobile-submenu-toggle[aria-expanded="true"] .mobile-submenu-icon {
        transform: rotate(180deg);
    }

    .mobile-submenu-item { /* Style for individual items inside mobile submenus */
        display: block; /* Ensure it takes full width */
        padding: 10px 20px; /* Adjust padding for nested items */
        color: var(--ivs-text-secondary); border-radius: 0.5rem;
        transition: background-color 0.2s, color 0.2s, transform 0.2s;
        text-align: left;
    }

    .mobile-submenu-item:hover {
        background-color: var(--ivs-bg-light); color: var(--ivs-text-primary);
        transform: translateX(5px); /* Slide effect */
    }

    /* Custom scrollbar for mobile menu */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: var(--ivs-bg-medium);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: var(--ivs-bg-light);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: var(--ivs-border);
    }

    #ivs-bottom-nav {
        background-color: rgba(13, 17, 23, 0.9); /* ivs-bg with opacity */
        backdrop-filter: blur(12px);
        border-top: 1px solid var(--ivs-border);
    }
    .bottom-nav-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        flex-grow: 1; color: var(--ivs-text-secondary); padding: 8px 0; /* More padding */
        transition: color 0.2s, background-color 0.2s; text-decoration: none;
        border-radius: 0.5rem; /* Rounded corners */
        margin: 0 4px; /* Space between items */
    }
    .bottom-nav-item:hover {
        background-color: rgba(249, 115, 22, 0.1); /* Subtle highlight on hover */
        color: var(--ivs-text-primary);
    }
    .bottom-nav-item.active { 
        color: var(--ivs-accent); 
        background-color: var(--ivs-link-active-bg);
    }
    .bottom-nav-text { 
        font-size: 0.75rem; /* Slightly larger text */
        margin-top: 4px; /* More spacing */
        font-weight: 500;
    }
</style>
<script>
    // Định nghĩa IVSHeaderController trong scope toàn cục (window) để loadComponents.js có thể truy cập
    const IVSHeaderController = {
        init() {
            this.cacheDOM();
            if (!this.header) {
                console.warn("[IVSHeader] Header element not found. UI logic will not run.");
                return;
            }
            this.bindEvents();
            this.updateActiveLinks();
            this.onScroll(); 
            this.updateLanguageDisplay(); // Call initially to set correct language text
            console.log("[IVSHeader] Header Controller Initialized.");
        },

        cacheDOM() {
            this.header = document.getElementById('ivs-main-header');
            this.mobilePanel = document.getElementById('ivs-mobile-menu-panel');
            this.mobileOpenBtn = document.getElementById('mobile-menu-open-btn');
            this.mobileCloseBtn = document.getElementById('mobile-menu-close-btn');
            this.mobileBackdrop = document.getElementById('ivs-mobile-menu-backdrop');
            this.bottomNavMenuBtn = document.getElementById('bottom-nav-menu-btn');
            this.submenuToggles = document.querySelectorAll('.mobile-submenu-toggle'); // Select all mobile submenu toggles
            this.navLinks = document.querySelectorAll('a.desktop-nav-link, .dropdown-item, #ivs-mobile-main-nav a, a.bottom-nav-item');
            this.langOptions = document.querySelectorAll('.lang-option'); // All language selection buttons
            
            // Mobile language specific elements
            this.mobileLangToggle = document.getElementById('mobile-lang-toggle');
            this.mobileLangDropdownContent = document.getElementById('mobile-lang-dropdown-content');
            this.mobileLangArrowIcon = document.getElementById('mobile-lang-arrow-icon');
            this.mobileLangDropdownContainer = document.getElementById('mobile-lang-dropdown-container'); // Parent container for click outside logic
        },

        bindEvents() {
            window.addEventListener('scroll', debounce(() => this.onScroll(), 50), { passive: true });
            
            this.mobileOpenBtn?.addEventListener('click', () => this.toggleMobileMenu(true));
            this.mobileCloseBtn?.addEventListener('click', () => this.toggleMobileMenu(false));
            this.mobileBackdrop?.addEventListener('click', () => this.toggleMobileMenu(false));
            this.bottomNavMenuBtn?.addEventListener('click', () => this.toggleMobileMenu(true));
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.mobilePanel?.classList.contains('is-open')) {
                    this.toggleMobileMenu(false);
                }
                // Close mobile language dropdown on escape
                if (e.key === 'Escape' && this.mobileLangDropdownContent && !this.mobileLangDropdownContent.classList.contains('hidden')) {
                    this.toggleMobileLanguageDropdown(false);
                }
            });

            // Universal click listener to close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                // Close desktop dropdowns
                document.querySelectorAll('.desktop-dropdown-container').forEach(container => {
                    const toggleButton = container.querySelector('.desktop-nav-dropdown-toggle');
                    const dropdownContent = container.querySelector('.desktop-dropdown, .desktop-mega-menu');
                    if (toggleButton && dropdownContent && !container.contains(e.target)) {
                        this.closeDesktopDropdown(toggleButton); // Call a function to close
                    }
                });

                // Close mobile language dropdown if clicked outside its container
                if (this.mobileLangDropdownContent && !this.mobileLangDropdownContent.classList.contains('hidden')) {
                    if (this.mobileLangDropdownContainer && !this.mobileLangDropdownContainer.contains(e.target)) {
                        this.toggleMobileLanguageDropdown(false);
                    }
                }
            });

            // Mobile submenu toggles
            this.submenuToggles.forEach(toggle => {
                toggle.addEventListener('click', (e) => this.toggleSubmenu(e.currentTarget));
            });

            // Mobile language toggle button
            this.mobileLangToggle?.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent document click from immediately closing
                this.toggleMobileLanguageDropdown();
            });

            // Language options click events
            this.langOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    const lang = e.currentTarget.dataset.lang;
                    if (lang) {
                        this.setLanguage(lang);
                    }
                });
            });
        },
        
        setLanguage(lang) {
            console.log(`[IVSHeader] Attempting to set language to: ${lang}`);
            if (window.system && typeof window.system.setLanguage === 'function') {
                window.system.setLanguage(lang);
            } else {
                console.warn('[IVSHeader] Language system (window.system.setLanguage) not found.');
            }
            this.updateLanguageDisplay(lang); // Update display for both desktop and mobile
            this.toggleMobileMenu(false); // Close mobile main menu if open
            this.toggleMobileLanguageDropdown(false); // Close mobile language dropdown
            // Close desktop dropdowns (language one specifically)
            document.querySelectorAll('.desktop-dropdown-container').forEach(container => {
                const toggleButton = container.querySelector('.desktop-nav-dropdown-toggle');
                if (toggleButton && toggleButton.querySelector('.fa-globe')) { // Check if it's the language dropdown
                    this.closeDesktopDropdown(toggleButton);
                }
            });
        },

        onScroll() {
            if (this.header) {
                this.header.classList.toggle('scrolled', window.scrollY > 10);
            }
        },
        
        toggleMobileMenu(open) {
            if (!this.mobilePanel) return;
            this.mobilePanel.classList.toggle('is-open', open);
            document.body.style.overflow = open ? 'hidden' : '';
        },

        toggleSubmenu(toggleButton) {
            const content = toggleButton.nextElementSibling;
            const icon = toggleButton.querySelector('.mobile-submenu-icon');
            if (!content || !icon) return;
            
            const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';

            // Close other mobile submenus at the same level
            let parentContainer = toggleButton.parentNode;
            // For nested-level-content, the parent is the div containing the toggle and its content
            // The siblings are other similar divs in the same mobile-submenu-content wrapper
            if (toggleButton.classList.contains('nested-level')) {
                parentContainer = toggleButton.closest('.mobile-submenu-content');
            }

            parentContainer.querySelectorAll('.mobile-submenu-toggle[aria-expanded="true"]').forEach(otherToggle => {
                if (otherToggle !== toggleButton) {
                    const otherContent = otherToggle.nextElementSibling;
                    const otherIcon = otherToggle.querySelector('.mobile-submenu-icon');
                    if (otherContent) otherContent.style.maxHeight = null;
                    if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                    otherToggle.setAttribute('aria-expanded', 'false');
                }
            });
            
            // Toggle current submenu
            if (isExpanded) {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
                toggleButton.setAttribute('aria-expanded', 'false');
            } else {
                // Set a small delay for height recalculation before expanding for smoother transition
                content.style.maxHeight = '0px'; // Reset to 0 before setting actual height
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px'; // Recalculate and set
                }, 10); // Small delay
                icon.style.transform = 'rotate(180deg)';
                toggleButton.setAttribute('aria-expanded', 'true');
            }
        },

        toggleDesktopDropdown(button, forceState) {
            const dropdown = button.parentNode.querySelector('.desktop-dropdown, .desktop-mega-menu');
            if (!dropdown) return;

            const isCurrentlyOpen = button.getAttribute('aria-expanded') === 'true';
            const shouldBeOpen = forceState !== undefined ? forceState : !isCurrentlyOpen;

            // Close all other desktop dropdowns
            document.querySelectorAll('.desktop-dropdown-container').forEach(container => {
                const otherButton = container.querySelector('.desktop-nav-dropdown-toggle');
                if (otherButton && otherButton !== button) {
                    this.closeDesktopDropdown(otherButton);
                }
            });

            if (shouldBeOpen) {
                dropdown.classList.remove('hidden');
                requestAnimationFrame(() => {
                    dropdown.classList.remove('opacity-0', 'scale-95', 'translate-y-[-15px]');
                    dropdown.classList.add('opacity-100', 'scale-100', 'translate-y-0');
                });
                button.setAttribute('aria-expanded', 'true');
            } else {
                dropdown.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
                dropdown.classList.add('opacity-0', 'scale-95', 'translate-y-[-15px]');
                dropdown.addEventListener('transitionend', function handler() {
                    if (dropdown.classList.contains('opacity-0')) { // Ensure transition finished
                         dropdown.classList.add('hidden');
                    }
                    this.removeEventListener('transitionend', handler);
                }, { once: true });
                button.setAttribute('aria-expanded', 'false');
            }
        },
        
        closeDesktopDropdown(button) {
            const dropdown = button.parentNode.querySelector('.desktop-dropdown, .desktop-mega-menu');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                 dropdown.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
                 dropdown.classList.add('opacity-0', 'scale-95', 'translate-y-[-15px]');
                 dropdown.addEventListener('transitionend', function handler() {
                     if (dropdown.classList.contains('opacity-0')) { // Ensure transition finished
                         dropdown.classList.add('hidden');
                     }
                     this.removeEventListener('transitionend', handler);
                 }, { once: true });
                 button.setAttribute('aria-expanded', 'false');
            }
        },


        // NEW: Toggle for mobile language dropdown
        toggleMobileLanguageDropdown(open) {
            if (!this.mobileLangToggle || !this.mobileLangDropdownContent || !this.mobileLangArrowIcon) return;

            const isCurrentlyOpen = this.mobileLangDropdownContent.classList.contains('opacity-100');
            const shouldBeOpen = open !== undefined ? open : !isCurrentlyOpen;

            // Close other dropdowns if any (desktop dropdowns, mobile main menu)
            if (this.mobilePanel.classList.contains('is-open')) {
                this.toggleMobileMenu(false);
            }
            document.querySelectorAll('.desktop-dropdown-container').forEach(container => {
                const toggleButton = container.querySelector('.desktop-nav-dropdown-toggle');
                if (toggleButton) {
                    this.closeDesktopDropdown(toggleButton);
                }
            });


            if (shouldBeOpen) {
                this.mobileLangDropdownContent.classList.remove('hidden');
                // Force reflow and then apply transitions for smoother open
                void this.mobileLangDropdownContent.offsetWidth; 
                requestAnimationFrame(() => { // Changed setTimeout to requestAnimationFrame
                    this.mobileLangDropdownContent.classList.remove('opacity-0', 'translate-y-[-10px]');
                    this.mobileLangDropdownContent.classList.add('opacity-100', 'translate-y-0');
                });
                
                this.mobileLangToggle.setAttribute('aria-expanded', 'true');
                this.mobileLangArrowIcon.style.transform = 'rotate(180deg)';
            } else {
                this.mobileLangDropdownContent.classList.remove('opacity-100', 'translate-y-0');
                this.mobileLangDropdownContent.classList.add('opacity-0', 'translate-y-[-10px]');
                this.mobileLangDropdownContent.addEventListener('transitionend', function handler() {
                    if (this.classList.contains('opacity-0')) {
                        this.classList.add('hidden');
                    }
                    this.removeEventListener('transitionend', handler);
                }, { once: true });
                this.mobileLangToggle.setAttribute('aria-expanded', 'false');
                this.mobileLangArrowIcon.style.transform = 'rotate(0deg)';
            }
        },

        updateLanguageDisplay(currentLang) {
            const lang = currentLang || (window.system ? window.system.getCurrentLanguage() : 'vi');
            const desktopLangDisplay = document.getElementById('current-lang-desktop');
            const mobileLangDisplay = document.getElementById('current-lang-mobile'); 
            
            if (desktopLangDisplay) {
                desktopLangDisplay.textContent = lang.toUpperCase();
            }
            if (mobileLangDisplay) { 
                mobileLangDisplay.textContent = lang.toUpperCase();
            }
        },

        updateActiveLinks() {
            const currentPath = window.location.pathname;
            const allLinks = document.querySelectorAll('a.nav-link, a.mobile-nav-link, a.mobile-nav-link-sub, a.bottom-nav-item');

            allLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPath || (href !== '/' && currentPath.startsWith(href))) {
                    link.classList.add('active');
                    const parentSubmenuContent = link.closest('.mobile-submenu-content');
                    if(parentSubmenuContent) {
                        const toggleButton = parentSubmenuContent.previousElementSibling;
                        // Only auto-open if it's a direct submenu (not a nested one that's already handled by its own parent toggle)
                        // This prevents unwanted expansion of nested items on page load
                        if (toggleButton && !toggleButton.classList.contains('nested-level')) {
                           this.toggleSubmenu(toggleButton); // Automatically open parent submenu
                        }
                    }
                } else {
                    link.classList.remove('active');
                }
            });
        }
    };

    // Make the controller globally accessible for loadComponents.js
    window.IVSHeaderController = IVSHeaderController;

    // Helper debounce function (if not already available from loadComponents.js)
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
</script>
