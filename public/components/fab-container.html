<!-- FILE: /public/components/fab-container.html -->
<!-- VERSION: 4.4 - Enhanced Accessibility, Responsiveness, and Performance -->
<!-- DESCRIPTION: Fully self-contained FAB component managing Scroll, Share, Contact, and Chatbot functionalities with improved accessibility, responsive design, and optimized performance. -->

<div id="fab-container-wrapper">
    <!-- Main FAB Buttons Container -->
    <div id="fab-buttons-container" class="fixed right-4 z-30 flex flex-col items-end space-y-3 bottom-20 md:bottom-4">
        <button id="scroll-to-top-btn" title="Lên đầu trang" aria-label="Lên đầu trang"
                class="fab-item flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 bg-neutral-600 dark:bg-neutral-700 text-white rounded-full shadow-lg hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-all duration-300 ease-out transform active:scale-90 opacity-0 scale-90 pointer-events-none focus:outline-none focus:ring-2 focus:ring-neutral-500">
            <i class="fas fa-arrow-up text-base sm:text-lg"></i>
        </button>

        <div class="relative group/fab">
            <button id="share-main-btn" title="Chia sẻ" aria-label="Mở menu chia sẻ" aria-haspopup="true" aria-expanded="false" aria-controls="share-options"
                    class="fab-item flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-emerald-500 hover:bg-emerald-600 text-white rounded-full shadow-xl transition-transform duration-200 transform hover:scale-110 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <i class="fas fa-share-alt text-xl sm:text-2xl"></i>
            </button>
            <div id="share-options" class="fab-submenu-panel" role="menu" aria-labelledby="share-main-btn"></div>
        </div>

        <div class="relative group/fab">
            <button id="contact-main-btn" title="Liên hệ" aria-label="Mở menu liên hệ" aria-haspopup="true" aria-expanded="false" aria-controls="contact-options"
                    class="fab-item flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-xl transition-transform duration-200 transform hover:scale-110 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-comment-dots text-xl sm:text-2xl"></i>
            </button>
            <div id="contact-options" class="fab-submenu-panel" role="menu" aria-labelledby="contact-main-btn"></div>
        </div>

        <button id="chatbot-open-button" title="Mở Chatbot AI" aria-label="Mở Chatbot AI"
                class="fab-item flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-purple-600 hover:bg-purple-700 text-white rounded-full shadow-xl transition-transform duration-200 transform hover:scale-110 active:scale-95 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <i class="fas fa-robot text-xl sm:text-2xl"></i>
        </button>
    </div>

    <!-- Chatbot UI Container -->
    <div id="chatbot-container" class="fixed bottom-4 right-4 md:right-6 bg-ivs-card border border-ivs-border rounded-2xl shadow-2xl flex flex-col overflow-hidden transition-all duration-300 ease-in-out z-40 transform scale-0 opacity-0 origin-bottom-right" style="width: calc(100% - 32px); max-width: 400px; height: calc(100% - 100px); max-height: 600px; display: none;">
        <header class="flex items-center justify-between p-3 border-b border-ivs-border flex-shrink-0">
            <div class="flex items-center">
                <img src="/images/logo/logo-192.png" alt="IVS Bot" class="w-10 h-10 rounded-full mr-3">
                <div>
                    <h3 class="font-bold text-white text-base">IVS AI Assistant</h3>
                    <p class="text-xs text-ivs-green">● Online</p>
                </div>
            </div>
            <button id="chatbot-close-button" class="text-ivs-text-secondary hover:text-white text-2xl focus:outline-none focus:ring-2 focus:ring-ivs-blue" aria-label="Đóng Chatbot">×</button>
        </header>
        <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto"></div>
        <footer class="p-3 border-t border-ivs-border bg-ivs-bg flex-shrink-0">
            <div class="flex items-center bg-ivs-bg border border-ivs-border rounded-lg">
                <input type="text" id="chatbot-input" placeholder="Type your message..." class="flex-1 bg-transparent px-4 py-2 text-white focus:outline-none" aria-label="Nhập tin nhắn">
                <button id="chatbot-send-button" class="p-3 text-ivs-blue hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-ivs-blue" aria-label="Gửi tin nhắn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </footer>
    </div>
</div>

<style>
    .fab-submenu-panel {
        position: absolute; 
        bottom: 100%; 
        right: 0; 
        margin-bottom: 0.5rem; 
        padding: 0.5rem;
        background-color: #161B22; 
        border-radius: 0.5rem; 
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        border: 1px solid #30363d; 
        display: flex; 
        flex-direction: column; 
        gap: 0.25rem;
        transition: all 0.2s ease-out; 
        opacity: 0; 
        transform: scale(0.95) translateY(10px); 
        pointer-events: none;
        min-width: 150px;
    }

    .fab-submenu-panel.active {
        opacity: 1; 
        transform: scale(1) translateY(0); 
        pointer-events: auto;
    }

    .fab-submenu-item {
        display: flex; 
        align-items: center; 
        padding: 0.5rem 1rem; 
        font-size: 0.9rem;
        color: #c9d1d9; 
        border-radius: 0.375rem; 
        transition: background-color 0.2s; 
        white-space: nowrap;
    }

    .fab-submenu-item:hover, .fab-submenu-item:focus {
        background-color: #30363d;
        outline: none;
    }

    .fab-submenu-item i { 
        margin-right: 0.75rem; 
        width: 1.25rem; 
        text-align: center; 
    }

    #chatbot-messages { 
        scrollbar-width: thin; 
        scrollbar-color: #30363d #161B22; 
    }

    #chatbot-messages::-webkit-scrollbar { 
        width: 6px; 
    }

    #chatbot-messages::-webkit-scrollbar-thumb { 
        background-color: #30363d; 
        border-radius: 3px; 
    }

    .typing-indicator span {
        height: 8px; 
        width: 8px; 
        margin: 0 1px; 
        background-color: #9ca3af;
        border-radius: 50%; 
        display: inline-block;
        animation: ivs-bounce 1.4s infinite ease-in-out both;
    }

    .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }

    @keyframes ivs-bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }

    @media (max-width: 640px) {
        #fab-buttons-container {
            right: 2rem;
            bottom: 5rem;
        }
        #chatbot-container {
            width: calc(100% - 1rem);
            max-height: 80vh;
        }
    }
</style>

<script>
// Utility for debouncing functions
const debounce = (func, wait) => {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
};

// Self-initializing logic for the entire FAB component
const IVSFabController = {
    dom: {},
    state: {
        isChatbotOpen: false,
        chatHistory: [
            { 
                role: "user", 
                parts: [{ 
                    text: "You are a helpful and professional AI assistant for IVS JSC, an education, technology, and human resources company in Vietnam. Your name is IVS AI Assistant. Provide concise, strategic, and helpful answers based on the company's services (consulting, web design, training partnerships, teacher supply, R&D, digital ecosystem like IVS Apps/Games/Read/QuickTest), key projects like EOV 2025, and philosophy (Integrate, Vision, Synergy). If you don't know an answer, say so. Start the first conversation with 'Hello! I am the IVS AI Assistant. How can I help you today?'" 
                }] 
            },
            { 
                role: "model", 
                parts: [{ 
                    text: "Hello! I am the IVS AI Assistant. How can I help you today?" 
                }] 
            }
        ],
    },

    init() {
        this.cacheDOM();
        if (!this.dom.fabButtonsContainer) {
            console.warn("[IVS Components] FAB container not found.");
            return;
        }
        this.populateMenus();
        this.bindEvents();
        this.addWelcomeMessage();
        console.log("[IVS Components] FAB & Chatbot Controller Initialized.");
    },

    cacheDOM() {
        this.dom.fabButtonsContainer = document.getElementById('fab-buttons-container');
        this.dom.scrollToTopBtn = document.getElementById('scroll-to-top-btn');
        this.dom.buttonsWithSubmenu = this.dom.fabButtonsContainer?.querySelectorAll('button[aria-haspopup="true"]') || [];
        this.dom.chatbotOpenBtn = document.getElementById('chatbot-open-button');
        this.dom.chatbotContainer = document.getElementById('chatbot-container');
        this.dom.chatbotCloseBtn = document.getElementById('chatbot-close-button');
        this.dom.chatbotMessages = document.getElementById('chatbot-messages');
        this.dom.chatbotInput = document.getElementById('chatbot-input');
        this.dom.chatbotSendBtn = document.getElementById('chatbot-send-button');
    },

    populateMenus() {
        const contactMenu = document.getElementById('contact-options');
        const shareMenu = document.getElementById('share-options');
        if (contactMenu) this.populateContactOptions(contactMenu);
        if (shareMenu) this.populateShareOptions(shareMenu);
    },

    populateContactOptions(element) {
        const contacts = [
            { text: "Hotline", href: "tel:+84896920547", icon: "fas fa-phone", color: "text-orange-500" },
            { text: "Email", href: "mailto:info@ivsacademy.edu.vn", icon: "fas fa-envelope", color: "text-red-500" },
            { text: "Zalo", href: "https://zalo.me/ivsjsc", icon: "fas fa-comment-dots", color: "text-blue-500" },
        ];
        element.innerHTML = contacts.map(c => 
            `<a href="${c.href}" role="menuitem" class="fab-submenu-item" ${c.href.startsWith('http') ? 'target="_blank" rel="noopener noreferrer"' : ''} tabindex="0"><i class="${c.icon} ${c.color}"></i><span>${c.text}</span></a>`
        ).join('');
    },

    populateShareOptions(element) {
        const currentUrl = window.location.href;
        const shares = [
            { 
                text: "Facebook", 
                icon: "fab fa-facebook-f", 
                color: "text-blue-600", 
                action: () => window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`, '_blank', 'noopener,noreferrer') 
            },
            { 
                text: "Copy Link", 
                icon: "fas fa-link", 
                color: "text-gray-500", 
                action: (btn) => {
                    navigator.clipboard.writeText(currentUrl).then(() => {
                        const originalContent = btn.innerHTML;
                        btn.innerHTML = `<i class="fas fa-check text-green-500"></i><span>Copied!</span>`;
                        setTimeout(() => { btn.innerHTML = originalContent; }, 2000);
                    }).catch(err => console.error('Failed to copy: ', err));
                }
            }
        ];
        element.innerHTML = shares.map(s => 
            `<button role="menuitem" class="fab-submenu-item w-full" tabindex="0"><i class="${s.icon} ${s.color}"></i><span>${s.text}</span></button>`
        ).join('');
        element.querySelectorAll('button').forEach((btn, index) => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                shares[index].actionscenes/action.js
                shares[index].action(btn);
            });
            btn.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') shares[index].action(btn);
            });
        });
    },

    bindEvents() {
        if (this.dom.scrollToTopBtn) {
            window.addEventListener('scroll(safe)', debounce(() => {
                this.dom.scrollToTopBtn.classList.toggle('opacity-0', window.scrollY < 200);
                this.dom.scrollToTopBtn.classList.toggle('pointer-events-none', window.scrollY < 200);
            }, 100), { passive: true });
            this.dom.scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        }

        this.dom.buttonsWithSubmenu.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById(btn.getAttribute('aria-controls'));
                const isOpening = !menu.classList.contains('active');
                this.closeAllSubmenus();
                if (isOpening) {
                    menu.classList.add('active');
                    btn.setAttribute('aria-expanded', 'true');
                    menu.querySelectorAll('[role="menuitem"]')[0]?.focus();
                }
            });
            btn.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    btn.click();
                }
            });
        });

        document.addEventListener('click', () => this.closeAllSubmenus());
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') this.closeAllSubmenus();
        });

        this.dom.chatbotOpenBtn.addEventListener('click', () => this.toggleChatbot(true));
        this.dom.chatbotOpenBtn.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') this.toggleChatbot(true);
        });
        this.dom.chatbotCloseBtn.addEventListener('click', () => this.toggleChatbot(false));

        this.dom.chatbotCloseBtn.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') this.toggleChatbot(false);
        });
        this.dom.chatbotSendBtn.addEventListener('click', () => this.handleSendMessage());
        this.dom.chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendMessage();
            }
        });
    },

    closeAllSubmenus() {
        this.dom.fabButtonsContainer.querySelectorAll('.fab-submenu-panel').forEach(m => {
            m.classList.remove('active');
            const btn = document.querySelector(`[aria-controls="${m.id}"]`);
            if (btn) btn.setAttribute('aria-expanded', 'false');
        });
    },

    toggleChatbot(forceOpen) {
        const open = typeof forceOpen === 'boolean' ? forceOpen : !this.state.isChatbotOpen;
        this.state.isChatbotOpen = open;
        if (open) {
            this.dom.chatbotContainer.style.display = 'flex';
            requestAnimationFrame(() => {
                this.dom.chatbotContainer.classList.remove('scale-0', 'opacity-0');
                this.dom.chatbotInput.focus();
            });
        } else {
            this.dom.chatbotContainer.classList.add('scale-0', 'opacity-0');
            setTimeout(() => { this.dom.chatbotContainer.style.display = 'none'; }, 300);
        }
    },

    addMessage(text, sender, isTyping = false) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-2`;
        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-[85%] rounded-2xl px-4 py-2 text-white ${sender === 'user' ? 'bg-ivs-blue' : 'bg-ivs-border'}`;
        if (isTyping) {
            messageBubble.id = 'typing-indicator';
            messageBubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
        } else {
            messageBubble.textContent = text;
        }
        messageWrapper.appendChild(messageBubble);
        this.dom.chatbotMessages.appendChild(messageWrapper);
        this.dom.chatbotMessages.scrollTop = this.dom.chatbotMessages.scrollHeight;
    },

    removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.parentElement.remove();
    },

    addWelcomeMessage() {
        this.addMessage(this.state.chatHistory[1].parts[0].text, 'model');
    },

    setLoading(isLoading) {
        this.dom.chatbotSendBtn.disabled = isLoading;
        this.dom.chatbotSendBtn.innerHTML = isLoading ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-paper-plane"></i>';
        this.dom.chatbotInput.disabled = isLoading;
    },

    async handleSendMessage() {
        const message = this.dom.chatbotInput.value.trim();
        if (!message) return;

        this.addMessage(message, 'user');
        this.dom.chatbotInput.value = '';
        this.setLoading(true);
        this.addMessage('', 'model', true);

        try {
            // **QUAN TRỌNG**: Thay thế bằng URL Cloud Function thực tế sau khi deploy.
            const backendUrl = 'https://asia-southeast1-ivsjsc-6362f.cloudfunctions.net/api/chat';

            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: this.state.chatHistory,
                    message: message,
                }),
                signal: AbortSignal.timeout(10000), // 10s timeout
            });

            this.removeTypingIndicator();
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            if (data.success && data.response) {
                const aiResponseText = data.response;
                this.addMessage(aiResponseText, 'model');
                this.state.chatHistory.push({ role: "user", parts: [{ text: message }] });
                this.state.chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
            } else {
                throw new Error(data.error || "Invalid response from server.");
            }
        } catch (error) {
            this.removeTypingIndicator();
            console.error("Error calling backend:", error);
            const errorMessage = error.name === 'TimeoutError' 
                ? "Sorry, the server took too long to respond. Please try again."
                : "Sorry, I'm having trouble connecting. Please try again later.";
            this.addMessage(errorMessage, 'model');
        } finally {
            this.setLoading(false);
        }
    }
};

// Make the controller globally available and initialize it
window.IVSFabController = IVSFabController;
IVSFabController.init();
</script>