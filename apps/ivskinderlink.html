<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVS KinderLink</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            color: #333;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('/images/apps/ivskinderlink.png');
            background-size: cover;
            background-position: center;
            filter: brightness(0.6);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        .login-box h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .school-info-login .school-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .school-info-login .school-details {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 30px;
        }


        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            text-align: left;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #loginError {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }

        .app-container {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-left .school-details-header {
            color: #7f8c8d;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .app-name-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }


        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px 20px;
            border-radius: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-details h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .user-role {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ee5a24;
            transform: translateY(-1px);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: #f0f2f5;
        }
        
        .tab-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-title {
            color: #2c3e50; 
            margin-bottom: 25px; 
            font-size: 2em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section-title {
            grid-column: 1 / -1;
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            margin-bottom: 10px;
        }
        
        .week-navigator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        .week-navigator button {
            background: none;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
         .week-navigator span {
            margin: 0 20px;
            font-weight: 600;
            font-size: 1.2em;
         }


        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
            vertical-align: middle;
            white-space: nowrap;
        }

        .data-table th {
            background: #f8f9fa;
            color: #343a40;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0, 0.05);
            border-left: 5px solid #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 1.1em;
            color: #7f8c8d;
        }

        .success-message, .permission-notice {
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s;
        }

        .success-message {
             background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .permission-notice {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            font-weight: 600;
        }
        
        .parent-dashboard, .placeholder-tab {
             background: rgba(255, 255, 255, 0.8);
             padding: 25px;
             border-radius: 15px;
        }
        
        .ai-report-placeholder {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0, 0.05);
        }
        .ai-report-placeholder h4 {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .ai-report-placeholder .chart-placeholder {
            background: #f0f2f5;
            height: 150px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-weight: 600;
        }
        
        .permission-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .permission-group {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
        }
        .permission-group h4 {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .permission-item label {
            margin-left: 8px;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .camera-feed {
            background: #000;
            border-radius: 15px;
            position: relative;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .camera-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-label {
            position: absolute;
            bottom: 15px;
            left: 20px;
            background: rgba(102, 126, 234, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        #notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .note-card {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .note-card p {
            margin-bottom: 10px;
        }
        .note-card .note-meta {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        .note-card .delete-note {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .app-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
        }
        .app-footer a {
            color: #fff;
            font-weight: 600;
            text-decoration: none;
        }
        .app-footer a:hover {
            text-decoration: underline;
        }

        /* Styles for hidden forms */
        .hidden-form-container {
            display: none;
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0, 0.05);
            margin-bottom: 20px;
        }
        /* AI report specific styles */
        .ai-report-content {
            background-color: #f9f9f9;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .ai-report-content p {
            margin-bottom: 10px;
        }
        .ai-report-content h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .ai-report-loading {
            text-align: center;
            padding: 20px;
            font-weight: 600;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .header, .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üëã ƒêƒÉng Nh·∫≠p</h1>
            <div class="school-info-login">
                <p class="school-name">H·ªá th·ªëng M·∫ßm non IVS</p>
                <p class="school-details">C∆° s·ªü Long Th√†nh | Hotline: 0912.345.678</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">üë§ T√™n ƒëƒÉng nh·∫≠p (SƒêT)</label>
                    <input type="text" id="username" required placeholder="T√™n t√†i kho·∫£n do tr∆∞·ªùng c·∫•p">
                </div>
                <div class="form-group">
                    <label for="password">üîí M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" required placeholder="M·∫≠t kh·∫©u">
                </div>
                <button type="submit" class="login-btn">üöÄ ƒêƒÉng Nh·∫≠p</button>
                <p id="loginError">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.</p>
            </form>
             <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; font-size: 14px; text-align: left;">
                <strong>T√†i kho·∫£n Demo:</strong><br>
                <small>
                    ‚Ä¢ Hi·ªáu tr∆∞·ªüng: <b>admin</b> / <b>admin123</b><br>
                    ‚Ä¢ Gi√°o vi√™n: <b>0987654321</b> / <b>123456</b><br>
                    ‚Ä¢ Ph·ª• huynh: <b>0901234567</b> / <b>123456</b>
                </small>
            </div>
        </div>
    </div>

    <div id="mainApp" class="container app-container">
        <header class="header">
            <div class="header-left">
                <h1>Tr∆∞·ªùng M·∫ßm Non IVS - C∆° s·ªü Long Th√†nh</h1>
                <p class="school-details-header">ƒê·ªãa ch·ªâ: 1104, T·ªï 6, ·∫§p ƒê·∫•t M·ªõi, X. Long Ph∆∞·ªõc, H. Long Th√†nh, ƒê·ªìng Nai | Hotline: 0912.345.678</p>
                <span class="app-name-tag">IVS KinderLink</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h3 id="currentUserName">Admin</h3>
                    <span class="user-role" id="currentUserRole">Hi·ªáu tr∆∞·ªüng</span>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <div class="nav-tabs" id="navTabs">
            <button data-tab="dashboard" class="nav-tab active" onclick="showTab('dashboard')">üìä T·ªïng Quan</button>
            <button data-tab="teachers" class="nav-tab" onclick="showTab('teachers')">üë©‚Äçüè´ Gi√°o Vi√™n</button>
            <button data-tab="children" class="nav-tab" onclick="showTab('children')">üë∂ Qu·∫£n L√Ω Tr·∫ª</button>
            <button data-tab="finance_nutrition" class="nav-tab" onclick="showTab('finance_nutrition')">üí∞ T√†i ch√≠nh & Dinh d∆∞·ª°ng</button>
             <button data-tab="notes" class="nav-tab" onclick="showTab('notes')">üìù Ghi ch√∫</button>
            <button data-tab="permissions" class="nav-tab" onclick="showTab('permissions')">üîë Ph√¢n Quy·ªÅn</button>
            <button data-tab="camera" class="nav-tab" onclick="showTab('camera')">üìπ Camera</button>
        </div>
        
        <div id="dashboard" class="tab-content active"></div>
        
        <div id="teachers" class="tab-content">
            <h2 class="tab-title">üë©‚Äçüè´ Qu·∫£n L√Ω H·ªì S∆° Gi√°o Vi√™n</h2>
            <div class="success-message" id="teacherSuccessMessage"></div>
            <button class="btn btn-primary" id="addTeacherBtn" style="margin-bottom: 20px;">+ Th√™m Gi√°o Vi√™n</button>
            <div id="teacherFormContainer" class="hidden-form-container">
                <h3 class="section-title">Th√™m Gi√°o Vi√™n M·ªõi</h3>
                <form id="teacherForm">
                    <div class="form-grid">
                        <h3 class="section-title">Th√¥ng Tin C√° Nh√¢n</h3>
                        <div class="form-group"><label for="teacherName">H·ªç v√† t√™n</label><input type="text" id="teacherName" required></div>
                        <div class="form-group"><label for="teacherPhone">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" id="teacherPhone" required></div>
                        <div class="form-group"><label for="teacherCCCD">S·ªë CCCD</label><input type="text" id="teacherCCCD" required></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="teacherAddress">ƒê·ªãa ch·ªâ</label><input type="text" id="teacherAddress" required></div>
                        
                        <h3 class="section-title">Th√¥ng Tin C√¥ng T√°c & T√†i Kho·∫£n</h3>
                        <div class="form-group"><label for="teacherClass">L·ªõp ph·ª• tr√°ch</label><select id="teacherClass" required><option value="">Ch·ªçn l·ªõp</option><option value="L·ªõp Ch·ªìi">L·ªõp Ch·ªìi</option><option value="L·ªõp L√°">L·ªõp L√°</option></select></div>
                        <div class="form-group"><label for="teacherUsername">T√™n ƒëƒÉng nh·∫≠p KinderLink</label><input type="text" id="teacherUsername" placeholder="V√≠ d·ª•: comai, thayhung..." required></div>
                        <div class="form-group"><label for="teacherPassword">M·∫≠t kh·∫©u</label><input type="password" id="teacherPassword" required></div>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u H·ªì S∆° Gi√°o Vi√™n</button>
                </form>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>H·ªç t√™n</th><th>L·ªõp</th><th>SƒêT</th><th>ƒê·ªãa ch·ªâ</th><th>T√†i kho·∫£n KinderLink</th><th>Thao t√°c</th></tr></thead>
                    <tbody id="teachersTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="children" class="tab-content">
            <h2 class="tab-title">üë∂ Qu·∫£n L√Ω H·ªì S∆° Tr·∫ª & Ph·ª• Huynh</h2>
            <div class="success-message" id="childSuccessMessage"></div>
            <button class="btn btn-primary" id="addChildBtn" style="margin-bottom: 20px;">+ Th√™m Tr·∫ª</button>
            <div id="childFormContainer" class="hidden-form-container">
                 <h3 class="section-title">Th√™m H·ªì S∆° Tr·∫ª M·ªõi</h3>
                 <form id="childForm">
                    <div class="form-grid">
                        <h3 class="section-title">Th√¥ng Tin Tr·∫ª</h3>
                        <div class="form-group"><label>H·ªç v√† t√™n tr·∫ª</label><input type="text" id="childName" required></div>
                        <div class="form-group"><label>Ng√†y sinh</label><input type="date" id="childBirthDate" required></div>
                        <div class="form-group"><label>Gi·ªõi t√≠nh</label><select id="childGender" required><option value="">Ch·ªçn</option><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div>
                        <div class="form-group"><label>L·ªõp h·ªçc</label><select id="childClassChild" required><option value="">Ch·ªçn</option><option value="L·ªõp Ch·ªìi">L·ªõp Ch·ªìi</option><option value="L·ªõp L√°">L·ªõp L√°</option></select></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="childAddress" required></div>
                        
                        <h3 class="section-title">Th√¥ng Tin S·ª©c Kh·ªèe & Kh·∫©n C·∫•p (R·∫•t quan tr·ªçng)</h3>
                        <div class="form-group"><label>D·ªã ·ª©ng (Th·ª©c ƒÉn, thu·ªëc...)</label><input type="text" id="childAllergies" placeholder="Ghi r√µ n·∫øu c√≥, kh√¥ng th√¨ b·ªè tr·ªëng"></div>
                        <div class="form-group"><label>Ghi ch√∫ s·ª©c kh·ªèe kh√°c</label><textarea id="childHealth" rows="2"></textarea></div>
                        <div class="form-group"><label>Ng∆∞·ªùi li√™n h·ªá kh·∫©n c·∫•p (ngo√†i cha m·∫π)</label><input type="text" id="emergencyContactName"></div>
                        <div class="form-group"><label>SƒêT li√™n h·ªá kh·∫©n c·∫•p</label><input type="tel" id="emergencyContactPhone"></div>

                        <h3 class="section-title">Th√¥ng Tin Ph·ª• Huynh & T√†i Kho·∫£n KinderLink</h3>
                        <div class="form-group"><label>H·ªç t√™n cha</label><input type="text" id="fatherName"></div>
                        <div class="form-group"><label>H·ªç t√™n m·∫π</label><input type="text" id="motherName"></div>
                        <div class="form-group"><label>SƒêT cha (d√πng l√†m t√†i kho·∫£n)</label><input type="tel" id="fatherPhone"></div>
                        <div class="form-group"><label>SƒêT m·∫π (d√πng l√†m t√†i kho·∫£n)</label><input type="tel" id="motherPhone"></div>
                        <div class="form-group"><label>Email li√™n h·ªá</label><input type="email" id="parentEmail" required></div>
                        <div class="form-group"><label>M·∫≠t kh·∫©u t√†i kho·∫£n PH</label><input type="password" id="parentPassword" placeholder="B·∫Øt bu·ªôc nh·∫≠p ƒë·ªÉ t·∫°o t√†i kho·∫£n" required></div>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u H·ªì S∆°</button>
                </form>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>H·ªç t√™n Tr·∫ª</th><th>L·ªõp</th><th>H·ªç t√™n Cha</th><th>H·ªç t√™n M·∫π</th><th>SƒêT li√™n l·∫°c</th><th>T√†i kho·∫£n KinderLink</th><th>Thao t√°c</th><th>B√°o c√°o AI</th>
                        </tr>
                    </thead>
                    <tbody id="childrenTableBody"></tbody>
                </table>
            </div>
            <div id="aiChildReportContainer" class="ai-report-placeholder" style="display: none;"></div>
        </div>

        <div id="finance_nutrition" class="tab-content">
        </div>
        
        <div id="notes" class="tab-content">
            <h2 class="tab-title">üìù Ghi Ch√∫ & Nh·∫Øc Vi·ªác</h2>
            <div class="success-message" id="noteSuccessMessage"></div>
            <form id="noteForm">
                <div class="form-group">
                    <label for="noteContent">N·ªôi dung ghi ch√∫</label>
                    <textarea id="noteContent" rows="4" required placeholder="V√≠ d·ª•: H·ªçp ph·ª• huynh to√†n tr∆∞·ªùng v√†o 8:00 s√°ng T7 tu·∫ßn n√†y..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Th√™m Ghi Ch√∫</button>
            </form>
            <div id="notes-container"></div>
        </div>

        <div id="permissions" class="tab-content">
            <h2 class="tab-title">üîë Ph√¢n Quy·ªÅn & B·∫£o M·∫≠t</h2>
            <p>L·ª±a ch·ªçn m·ªôt nh√≥m ho·∫∑c t√†i kho·∫£n c·ª• th·ªÉ ƒë·ªÉ t√πy ch·ªânh quy·ªÅn truy c·∫≠p chi ti·∫øt v√†o c√°c module c·ªßa h·ªá th·ªëng.</p>
            <div class="form-group" style="max-width: 400px; margin-top: 20px;">
                <label for="permissionTarget">Ch·ªçn ƒë·ªëi t∆∞·ª£ng ph√¢n quy·ªÅn</label>
                <select id="permissionTarget" class="form-control"></select>
            </div>
            <div class="success-message" id="permissionSuccessMessage"></div>
            <div id="permissionMatrixContainer" class="permission-matrix" style="margin-top:20px;"></div>
            <div id="passwordResetContainer" style="display:none; margin-top: 20px; background: #fff; padding: 20px; border-radius: 10px;">
                <h3 class="section-title">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h3>
                <div class="form-group">
                    <label for="newPasswordForUser">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="newPasswordForUser" class="form-control">
                </div>
                <button id="resetPasswordBtn" class="btn btn-danger">X√°c nh·∫≠n ƒê·∫∑t l·∫°i M·∫≠t kh·∫©u</button>
            </div>
        </div>

        <div id="users" class="tab-content">
            <h2 class="tab-title">üë• Qu·∫£n L√Ω T√†i Kho·∫£n ƒêƒÉng Nh·∫≠p</h2>
            <p>T√†i kho·∫£n ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông khi th√™m h·ªì s∆° gi√°o vi√™n ho·∫∑c tr·∫ª. T·∫°i ƒë√¢y ch·ªâ hi·ªÉn th·ªã ƒë·ªÉ tra c·ª©u v√† x√≥a.</p>
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>ID</th><th>T√™n ƒëƒÉng nh·∫≠p</th><th>Vai tr√≤</th><th>ƒê·ªëi t∆∞·ª£ng li√™n k·∫øt</th><th>Thao t√°c</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="camera" class="tab-content">
             <h2 class="tab-title">üìπ H·ªá Th·ªëng Camera Gi√°m S√°t</h2>
             <div class="permission-notice" id="cameraPermissionNotice" style="display: none;"></div>
             <div id="cameraGrid" class="camera-grid"></div>
        </div>
        
        <footer class="app-footer">
            <p><strong>IVS KinderLink</strong> - N·ªÅn t·∫£ng k·∫øt n·ªëi to√†n di·ªán cho gi√°o d·ª•c m·∫ßm non.</p>
            <p>D·ªØ li·ªáu ƒë∆∞·ª£c b·∫£o v·ªá b·ªüi m√£ h√≥a AES-256. | Theo d√µi ch√∫ng t√¥i tr√™n <a href="https://www.facebook.com/ivs.edu.vn" target="_blank">Fanpage Facebook</a>.</p>
        </footer>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let db = {
        users: [
            { id: 1, username: 'admin', password: 'admin123', role: 'principal', name: 'Ban Gi√°m Hi·ªáu', linkedId: null },
            { id: 2, username: '0987654321', password: '123456', role: 'teacher', name: 'C√¥ Mai', linkedId: 401 },
            { id: 3, username: '0901234567', password: '123456', role: 'parent', name: 'PH b√© An Nhi√™n', linkedId: 101 }
        ],
        teachers: [
            { id: 401, name: 'C√¥ Mai', phone: '0987654321', cccd: '012345678901', address: '123 ƒê∆∞·ªùng ABC, TPHCM', assignedClass: 'L·ªõp Ch·ªìi' },
            { id: 402, name: 'C√¥ Lan', phone: '0987111222', cccd: '012345678902', address: '456 ƒê∆∞·ªùng XYZ, TPHCM', assignedClass: 'L·ªõp L√°' }
        ],
        children: [
            { id: 101, name: 'Nguy·ªÖn An Nhi√™n', birthDate: '2022-05-20', gender: 'N·ªØ', class: 'L·ªõp Ch·ªìi', address: '123 ƒê∆∞·ªùng ABC, Q1, TPHCM', health: 'B√¨nh th∆∞·ªùng', allergies: 'Kh√¥ng', emergencyContactName: 'B√† ngo·∫°i - Tr·∫ßn Th·ªã C', emergencyContactPhone: '0903333444' },
            { id: 102, name: 'Tr·∫ßn Minh Khang', birthDate: '2022-03-15', gender: 'Nam', class: 'L·ªõp Ch·ªìi', address: '456 ƒê∆∞·ªùng XYZ, Q2, TPHCM', health: 'D·ªã ·ª©ng s·ªØa', allergies: 'S·ªØa b√≤', emergencyContactName: '√îng n·ªôi - Tr·∫ßn VƒÉn B', emergencyContactPhone: '0902222333'},
            { id: 103, name: 'L√™ Th·∫£o Vy', birthDate: '2021-08-10', gender: 'N·ªØ', class: 'L·ªõp L√°', address: '789 ƒê∆∞·ªùng KLM, Q3, TPHCM', health: 'B√¨nh th∆∞·ªùng', allergies: 'Kh√¥ng', emergencyContactName: 'B√† n·ªôi - L√™ Th·ªã D', emergencyContactPhone: '0901111222' }
        ],
        parents: [
            { id: 201, fatherName: 'Nguy·ªÖn VƒÉn Khoa', motherName: 'ƒê·∫∑ng Th·ªã B√≠ch', fatherPhone: '0901234567', motherPhone: '0908765432', email: 'khoa.nv@email.com', childId: 101 },
            { id: 202, fatherName: 'Tr·∫ßn VƒÉn An', motherName: 'L√Ω Th·ªã B√¨nh', fatherPhone: '0912345678', motherPhone: '0918765432', email: 'an.tv@email.com', childId: 102 }
        ],
        fees: [
            { id: 501, childId: 101, description: 'H·ªçc ph√≠ Th√°ng 06/2025', amount: 5000000, dueDate: '2025-06-15', status: 'paid' },
            { id: 502, childId: 102, description: 'H·ªçc ph√≠ Th√°ng 06/2025', amount: 5000000, dueDate: '2025-06-15', status: 'unpaid' },
            { id: 503, childId: 101, description: 'Ph√≠ ƒÉn Th√°ng 06/2025', amount: 1200000, dueDate: '2025-06-15', status: 'paid' },
        ],
        menus: [
             { day: 'Th·ª© Hai', breakfast: 'Ch√°o y·∫øn m·∫°ch', lunch: 'C∆°m, th·ªãt kho, canh b√≠ ƒë·ªè', snack: 'S·ªØa chua', calories: 1200 },
             { day: 'Th·ª© Ba', breakfast: 'Ph·ªü b√≤', lunch: 'C∆°m, c√° chi√™n, canh rau ng√≥t', snack: 'B√°nh flan', calories: 1250 },
             { day: 'Th·ª© T∆∞', breakfast: 'B√∫n b√≤ Hu·∫ø', lunch: 'C∆°m g√† x·ªëi m·ª°', snack: 'Tr√°i c√¢y', calories: 1300 },
             { day: 'Th·ª© NƒÉm', breakfast: 'X√¥i g·∫•c', lunch: 'M√¨ √ù s·ªët b√≤ b·∫±m', snack: 'ƒê·∫≠u h≈© non', calories: 1150 },
             { day: 'Th·ª© S√°u', breakfast: 'B√°nh m√¨ ·ªëp la', lunch: 'C∆°m t·∫•m s∆∞·ªùn b√¨ ch·∫£', snack: 'Ch√® h·∫°t sen', calories: 1400 },
        ],
        foodOptions: {
            breakfast: ['Ch√°o y·∫øn m·∫°ch', 'Ph·ªü b√≤', 'B√∫n b√≤ Hu·∫ø', 'X√¥i g·∫•c', 'B√°nh m√¨ ·ªëp la', 'H·ªß ti·∫øu'],
            lunch: ['C∆°m, th·ªãt kho, canh b√≠ ƒë·ªè', 'C∆°m, c√° chi√™n, canh rau ng√≥t', 'C∆°m g√† x·ªëi m·ª°', 'M√¨ √ù s·ªët b√≤ b·∫±m', 'C∆°m t·∫•m s∆∞·ªùn b√¨ ch·∫£', 'B√≤ l√∫c l·∫Øc khoai t√¢y chi√™n'],
            snack: ['S·ªØa chua', 'B√°nh flan', 'Tr√°i c√¢y', 'ƒê·∫≠u h≈© non', 'Ch√® h·∫°t sen', 'S·ªØa t∆∞∆°i']
        },
        notes: [
            { id: 601, content: 'H·ªçp ph·ª• huynh to√†n tr∆∞·ªùng v√†o 8:00 s√°ng T7 tu·∫ßn n√†y.', createdBy: 'Ban Gi√°m Hi·ªáu', createdAt: '2025-06-10' }
        ],
        cameras: [
            { id: 301, name: 'S√¢n ch∆°i', class: 'Chung', url: 'https://placehold.co/600x400/000000/FFFFFF?text=S√¢n+Ch∆°i+(Live)' },
            { id: 302, name: 'L·ªõp Ch·ªìi - G√≥c h·ªçc t·∫≠p', class: 'L·ªõp Ch·ªìi', url: 'https://placehold.co/600x400/000000/FFFFFF?text=L·ªõp+Ch·ªìi+(Live)' },
            { id: 303, name: 'L·ªõp L√° - Gi·ªù ƒÉn', class: 'L·ªõp L√°', url: 'https://placehold.co/600x400/000000/FFFFFF?text=L·ªõp+L√°+(Live)' },
            { id: 304, name: 'Khu v·ªá sinh', class: 'Chung', url: 'https://placehold.co/600x400/000000/FFFFFF?text=Khu+V·ªá+Sinh+(Live)' }
        ],
        permissions: {
            roles: {
                principal: {
                    dashboard: true, teachers: true, children: true, finance_nutrition: true, notes: true, users: true, permissions: true, camera: true,
                    cameras: [301, 302, 303, 304] 
                },
                teacher: {
                    dashboard: true, teachers: false, children: true, finance_nutrition: false, notes: true, users: false, permissions: false, camera: true,
                    cameras: [301, 302] 
                },
                parent: {
                    dashboard: true, teachers: false, children: false, finance_nutrition: true, notes: false, users: false, permissions: false, camera: true,
                    cameras: [301, 302] 
                }
            },
            users: {
                3: { 
                    cameras: [301, 302] 
                }
            } 
        },
        modules: [
            { id: 'dashboard', name: 'T·ªïng Quan' },
            { id: 'teachers', name: 'Qu·∫£n l√Ω Gi√°o vi√™n' },
            { id: 'children', name: 'Qu·∫£n l√Ω Tr·∫ª' },
            { id: 'finance_nutrition', name: 'T√†i ch√≠nh & Dinh d∆∞·ª°ng' },
            { id: 'notes', name: 'Ghi ch√∫' },
            { id: 'permissions', name: 'Ph√¢n quy·ªÅn' },
            { id: 'camera', name: 'Camera' }
        ]
    };

    let currentUser = null;
    let currentWeekOffset = 0; 
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    
    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
    const handleLogin = (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const foundUser = db.users.find(user => user.username === username && user.password === password);
        if (foundUser) {
            currentUser = foundUser;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginForm').reset();
            initializeApp();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    };

    // Kh·ªüi t·∫°o ·ª©ng d·ª•ng sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
    const initializeApp = () => {
        setupPermissions();
        renderAll();
        showTab('dashboard');
    };
    
    // Thi·∫øt l·∫≠p quy·ªÅn cho ng∆∞·ªùi d√πng hi·ªán t·∫°i
    const setupPermissions = () => {
        const userPermissions = db.permissions.users[currentUser.id] || db.permissions.roles[currentUser.role];
        
        document.querySelectorAll('.nav-tab').forEach(tab => {
            const tabId = tab.getAttribute('data-tab');
            if (currentUser.role === 'principal' || (userPermissions && userPermissions[tabId])) {
                tab.style.display = 'flex';
            } else {
                tab.style.display = 'none';
            }
        });
        
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
        const roleNames = { principal: 'Hi·ªáu tr∆∞·ªüng', teacher: 'Gi√°o vi√™n', parent: 'Ph·ª• huynh' };
        document.getElementById('currentUserRole').textContent = roleNames[currentUser.role];
    };

    // Render t·∫•t c·∫£ c√°c ph·∫ßn c·ªßa ·ª©ng d·ª•ng
    const renderAll = () => {
        renderDashboard();
        renderTeachersTable();
        renderChildrenTable();
        renderFinanceAndNutrition();
        renderNotes();
        renderUsersTable();
        renderCameras();
        populatePermissionTargets();
        renderPermissionMatrix();
    };
    
    // Render trang t·ªïng quan (Dashboard)
    const renderDashboard = () => {
        const dashboardContent = document.getElementById('dashboard');
        if (currentUser.role === 'parent') {
            const child = db.children.find(c => c.id === currentUser.linkedId);
            const parentInfo = db.parents.find(p => p.childId === currentUser.linkedId);
            dashboardContent.innerHTML = `<h2 class="tab-title">üåü Th√¥ng tin c·ªßa b√© ${child.name}</h2>
                <div class="parent-dashboard" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><h3>Th√¥ng tin c∆° b·∫£n</h3><p><strong>Ng√†y sinh:</strong> ${child.birthDate}</p><p><strong>L·ªõp:</strong> ${child.class}</p><p><strong>S·ª©c kh·ªèe:</strong> ${child.health}</p><p><strong>D·ªã ·ª©ng:</strong> ${child.allergies || 'Kh√¥ng'}</p></div>
                    <div><h3>Th√¥ng tin Ph·ª• huynh & Kh·∫©n c·∫•p</h3><p><strong>Cha:</strong> ${parentInfo.fatherName} - ${parentInfo.fatherPhone}</p><p><strong>M·∫π:</strong> ${parentInfo.motherName} - ${parentInfo.motherPhone}</p><p><strong>Email:</strong> ${parentInfo.email}</p><p><strong>Li√™n h·ªá kh·∫©n c·∫•p:</strong> ${child.emergencyContactName || 'Ch∆∞a c√≥'} - ${child.emergencyContactPhone || ''}</p></div>
                </div>`;
        } else {
            dashboardContent.innerHTML = `<h2 class="tab-title">üìä T·ªïng Quan Ho·∫°t ƒê·ªông</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number">${db.teachers.length}</div><div class="stat-label">Gi√°o vi√™n</div></div>
                    <div class="stat-card"><div class="stat-number">${db.children.length}</div><div class="stat-label">T·ªïng s·ªë tr·∫ª</div></div>
                    <div class="stat-card"><div class="stat-number">${db.users.filter(u=>u.role==='parent').length}</div><div class="stat-label">T√†i kho·∫£n PH</div></div>
                    <div class="stat-card"><div class="stat-number">${db.cameras.length}</div><div class="stat-label">Camera</div></div>
                </div>
                <div class="ai-report-placeholder">
                    <h4>B√°o c√°o Ph√¢n t√≠ch Th√¥ng minh (AI Demo)</h4>
                    <div class="chart-placeholder">Bi·ªÉu ƒë·ªì ph√¢n t√≠ch xu h∆∞·ªõng ph√°t tri·ªÉn k·ªπ nƒÉng c·ªßa tr·∫ª</div>
                </div>`;
        }
    };
    
    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
    const showSuccessMessage = (elementId, message) => {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2000);
    };

    // Render b·∫£ng gi√°o vi√™n
    const renderTeachersTable = () => {
        const tableBody = document.getElementById('teachersTableBody');
        tableBody.innerHTML = '';
        db.teachers.forEach(t => {
            const userAccount = db.users.find(u => u.role === 'teacher' && u.linkedId === t.id);
            tableBody.innerHTML += `<tr>
                <td>${t.name}</td><td>${t.assignedClass}</td><td>${t.phone}</td><td>${t.address}</td>
                <td>${userAccount ? userAccount.username : 'Ch∆∞a t·∫°o'}</td>
                <td><button class="btn btn-danger" onclick="deleteTeacher(${t.id})">X√≥a</button></td>
            </tr>`;
        });
    };
    
    // Render b·∫£ng tr·∫ª em
    const renderChildrenTable = () => {
        const tableBody = document.getElementById('childrenTableBody');
        tableBody.innerHTML = '';
        let childrenToShow = db.children;
        if(currentUser.role === 'teacher') {
            const teacher = db.teachers.find(t=>t.id===currentUser.linkedId);
            childrenToShow = teacher ? db.children.filter(c => c.class === teacher.assignedClass) : [];
        }
        childrenToShow.forEach(c => {
            const parentInfo = db.parents.find(p => p.childId === c.id) || {};
            const userInfo = db.users.find(u => u.role === 'parent' && u.linkedId === c.id) || {};
            tableBody.innerHTML += `<tr>
                <td>${c.name}</td><td>${c.class}</td><td>${parentInfo.fatherName || 'N/A'}</td><td>${parentInfo.motherName || 'N/A'}</td>
                <td>${parentInfo.fatherPhone || parentInfo.motherPhone || 'N/A'}</td>
                <td>${userInfo.username || 'Ch∆∞a t·∫°o'}</td>
                <td><button class="btn btn-danger" onclick="deleteChild(${c.id})">X√≥a</button></td>
                <td><button class="btn btn-primary" onclick="generateChildReport(${c.id})">‚ú® B√°o C√°o AI</button></td>
            </tr>`;
        });
    };

    // Render b·∫£ng t√†i kho·∫£n ng∆∞·ªùi d√πng
    const renderUsersTable = () => {
        const tableBody = document.getElementById('usersTableBody');
        tableBody.innerHTML = '';
        db.users.filter(u => u.role !== 'principal').forEach(u => {
            let linkedName = "N/A";
            if (u.role === 'teacher') linkedName = `GV: ${db.teachers.find(t => t.id === u.linkedId)?.name || 'Kh√¥ng r√µ'}`;
            else if (u.role === 'parent') linkedName = `PH b√©: ${db.children.find(c => c.id === u.linkedId)?.name || 'Kh√¥ng r√µ'}`;
            tableBody.innerHTML += `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.role}</td><td>${linkedName}</td><td><button class="btn btn-danger" onclick="deleteUser(${u.id})">X√≥a</button></td></tr>`;
        });
    };
    
    // L·∫•y kho·∫£ng ng√†y trong tu·∫ßn
    const getWeekDateRange = (offset) => {
        const now = new Date();
        now.setDate(now.getDate() + offset * 7);
        const dayOfWeek = now.getDay();
        const diffToMonday = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        const monday = new Date(now.setDate(diffToMonday));
        const friday = new Date(new Date(monday).setDate(monday.getDate() + 4));
        const formatDate = (date) => `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        return `Tu·∫ßn t·ª´ ${formatDate(monday)} ƒë·∫øn ${formatDate(friday)}, ${monday.getFullYear()}`;
    };

    // Render ph·∫ßn t√†i ch√≠nh v√† dinh d∆∞·ª°ng
    const renderFinanceAndNutrition = () => {
        const container = document.getElementById('finance_nutrition');
        let content = `<h2 class="tab-title">üí∞ T√†i ch√≠nh & Dinh d∆∞·ª°ng</h2>`;

        let feesToShow = [];
        if (currentUser.role === 'parent') {
            const child = db.children.find(c => c.id === currentUser.linkedId);
            feesToShow = db.fees.filter(f => f.childId === currentUser.linkedId);
            content += `<h3 class="section-title">H·ªçc ph√≠ c·ªßa b√© ${child.name}</h3>`;
        } else {
            feesToShow = db.fees;
            content += `<h3 class="section-title">Qu·∫£n l√Ω H·ªçc ph√≠ (Demo)</h3>`;
        }

        let feeTable = `<div class="table-container"><table class="data-table">
            <thead><tr><th>H·ªç t√™n tr·∫ª</th><th>Kho·∫£n thu</th><th>S·ªë ti·ªÅn</th><th>H·∫°n n·ªôp</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead>
            <tbody>`;
        
        feesToShow.forEach(fee => {
            const childName = db.children.find(c => c.id === fee.childId)?.name || 'N/A';
            const statusStyle = fee.status === 'paid' ? 'color: green; font-weight: bold;' : 'color: red; font-weight: bold;';
            const statusText = fee.status === 'paid' ? 'ƒê√£ n·ªôp' : 'Ch∆∞a n·ªôp';
            const actionButton = fee.status === 'unpaid' && currentUser.role !== 'parent' ? `<button class="btn btn-primary btn-sm">G·ª≠i nh·∫Øc nh·ªü</button>` : `<button class="btn btn-primary btn-sm" disabled>Xem chi ti·∫øt</button>`;
            feeTable += `<tr><td>${childName}</td><td>${fee.description}</td><td>${fee.amount.toLocaleString('vi-VN')} ƒë</td><td>${fee.dueDate}</td><td style="${statusStyle}">${statusText}</td><td>${actionButton}</td></tr>`;
        });
        feeTable += '</tbody></table></div>';
        content += feeTable;

        content += `<h3 class="section-title" style="margin-top: 40px;">Th·ª±c ƒë∆°n & Dinh d∆∞·ª°ng</h3>
            <div class="week-navigator">
                <button id="prevWeekBtn">Tu·∫ßn tr∆∞·ªõc</button>
                <span id="weekDisplay">${getWeekDateRange(currentWeekOffset)}</span>
                <button id="nextWeekBtn">Tu·∫ßn sau</button>
            </div>
            <div class="table-container"><table class="data-table">
            <thead><tr><th>Th·ª©</th><th>B·ªØa s√°ng</th><th>B·ªØa tr∆∞a</th><th>B·ªØa x·∫ø</th><th>L∆∞·ª£ng Calo (∆∞·ªõc t√≠nh)</th></tr></thead>
            <tbody id="menuTableBody">`;
        
        db.menus.forEach(menu => {
            if (currentUser.role === 'principal') {
                 content += `<tr><td>${menu.day}</td>
                    <td><select class="form-control" data-day="${menu.day}" data-meal="breakfast">${db.foodOptions.breakfast.map(f => `<option ${f === menu.breakfast ? 'selected' : ''}>${f}</option>`).join('')}</select></td>
                    <td><select class="form-control" data-day="${menu.day}" data-meal="lunch">${db.foodOptions.lunch.map(f => `<option ${f === menu.lunch ? 'selected' : ''}>${f}</option>`).join('')}</select></td>
                    <td><select class="form-control" data-day="${menu.day}" data-meal="snack">${db.foodOptions.snack.map(f => `<option ${f === menu.snack ? 'selected' : ''}>${f}</option>`).join('')}</select></td>
                    <td>${menu.calories} Kcal</td></tr>`;
            } else {
                content += `<tr><td>${menu.day}</td><td>${menu.breakfast}</td><td>${menu.lunch}</td><td>${menu.snack}</td><td>${menu.calories} Kcal</td></tr>`;
            }
        });
        content += '</tbody></table></div>';
        
        container.innerHTML = content;
        
        document.getElementById('prevWeekBtn').addEventListener('click', () => { currentWeekOffset--; renderFinanceAndNutrition(); });
        document.getElementById('nextWeekBtn').addEventListener('click', () => { currentWeekOffset++; renderFinanceAndNutrition(); });
        
        if (currentUser.role === 'principal') {
            container.querySelectorAll('select[data-day]').forEach(select => {
                select.addEventListener('change', (e) => {
                    const day = e.target.getAttribute('data-day');
                    const meal = e.target.getAttribute('data-meal');
                    const value = e.target.value;
                    const menuItem = db.menus.find(m => m.day === day);
                    if(menuItem) menuItem[meal] = value;
                    showSuccessMessage('permissionSuccessMessage', 'ƒê√£ c·∫≠p nh·∫≠t th·ª±c ƒë∆°n!');
                });
            });
        }
    };
    
    // Render ghi ch√∫
    const renderNotes = () => {
        const container = document.getElementById('notes-container');
        container.innerHTML = '';
        db.notes.slice().reverse().forEach(note => {
            const noteCard = document.createElement('div');
            noteCard.className = 'note-card';
            noteCard.innerHTML = `
                <p>${note.content}</p>
                <div class="note-meta">T·∫°o b·ªüi: ${note.createdBy} - ${note.createdAt}</div>
                <button class="delete-note" onclick="deleteNote(${note.id})">X</button>
            `;
            container.appendChild(noteCard);
        });
    };

    // Render camera d·ª±a tr√™n quy·ªÅn c·ªßa ng∆∞·ªùi d√πng
    const renderCameras = () => {
        const cameraGrid = document.getElementById('cameraGrid');
        const permissionNotice = document.getElementById('cameraPermissionNotice');
        cameraGrid.innerHTML = '';
        permissionNotice.style.display = 'none';
        
        const userPermissions = db.permissions.users[currentUser.id] || db.permissions.roles[currentUser.role];
        const allowedCameraIds = userPermissions.cameras || [];

        if (currentUser.role === 'principal' || (userPermissions && userPermissions.camera)) {
            const camerasToShow = db.cameras.filter(cam => allowedCameraIds.includes(cam.id));

            if (currentUser.role === 'parent') {
                permissionNotice.textContent = '‚ö†Ô∏è V√¨ l√Ω do b·∫£o m·∫≠t, ph·ª• huynh ch·ªâ c√≥ quy·ªÅn xem camera c·ªßa l·ªõp con em m√¨nh v√† c√°c khu v·ª±c sinh ho·∫°t chung.';
                permissionNotice.style.display = 'block';
            }

            if (camerasToShow.length === 0 && currentUser.role !== 'principal') {
                cameraGrid.innerHTML = `<p style="text-align: center; color: #7f8c8d;">B·∫°n kh√¥ng c√≥ quy·ªÅn xem camera n√†o.</p>`;
            } else {
                camerasToShow.forEach(cam => {
                    cameraGrid.innerHTML += `
                        <div class="camera-feed">
                            <img src="${cam.url}" alt="${cam.name}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/000000/FFFFFF?text=Error';">
                            <div class="camera-label">${cam.name}</div>
                        </div>
                    `;
                });
            }
        } else {
            permissionNotice.textContent = '‚õî B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p v√†o m·ª•c Camera.';
            permissionNotice.style.display = 'block';
        }
    };
    
    // ƒêi·ªÅn danh s√°ch ƒë·ªëi t∆∞·ª£ng ph√¢n quy·ªÅn (vai tr√≤ v√† t√†i kho·∫£n)
    const populatePermissionTargets = () => {
        const select = document.getElementById('permissionTarget');
        select.innerHTML = '<option value="">Ch·ªçn ƒë·ªëi t∆∞·ª£ng...</option>';
        select.innerHTML += '<optgroup label="Nh√≥m Vai tr√≤">';
        Object.keys(db.permissions.roles).forEach(role => {
            const roleName = { principal: 'Hi·ªáu tr∆∞·ªüng', teacher: 'Gi√°o vi√™n', parent: 'Ph·ª• huynh' }[role] || role;
            select.innerHTML += `<option value="role_${role}">Nh√≥m: ${roleName}</option>`;
        });
        select.innerHTML += '</optgroup><optgroup label="T√†i kho·∫£n c√° nh√¢n">';
        db.users.filter(u => u.role !== 'principal').forEach(user => {
            select.innerHTML += `<option value="user_${user.id}">T√†i kho·∫£n: ${user.name} (${user.username})</option>`;
        });
        select.innerHTML += '</optgroup>';
    };
    
    // Render ma tr·∫≠n ph√¢n quy·ªÅn
    const renderPermissionMatrix = () => {
        const target = document.getElementById('permissionTarget').value;
        const container = document.getElementById('permissionMatrixContainer');
        const passwordResetContainer = document.getElementById('passwordResetContainer');
        container.innerHTML = '';
        passwordResetContainer.style.display = 'none';
        if (!target) return;

        const [type, id] = target.split('_');
        let targetPermissions = (type === 'user') 
            ? (db.permissions.users[id] || { ...db.permissions.roles[db.users.find(u=>u.id==id).role] }) 
            : db.permissions.roles[id];

        if (type === 'user' && !db.permissions.users[id]) {
            db.permissions.users[id] = { ...targetPermissions }; 
        }
        if (type === 'user' && !db.permissions.users[id].cameras) {
            db.permissions.users[id].cameras = [];
        }
        if (type === 'role' && !db.permissions.roles[id].cameras) {
            db.permissions.roles[id].cameras = [];
        }


        const moduleGroups = {
            'Qu·∫£n l√Ω chung': ['dashboard', 'teachers', 'children'],
            'Nghi·ªáp v·ª•': ['finance_nutrition', 'notes'],
            'H·ªá th·ªëng': ['permissions', 'camera']
        };

        for (const groupName in moduleGroups) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'permission-group';
            groupDiv.innerHTML = `<h4>${groupName}</h4>`;
            moduleGroups[groupName].forEach(moduleId => {
                const module = db.modules.find(m => m.id === moduleId);
                if (module) {
                    const isChecked = targetPermissions[moduleId] ? 'checked' : '';
                    groupDiv.innerHTML += `
                        <div class="permission-item">
                            <input type="checkbox" id="perm_${moduleId}" data-module="${moduleId}" ${isChecked}>
                            <label for="perm_${moduleId}">${module.name}</label>
                        </div>`;
                }
            });
            container.appendChild(groupDiv);
        }

        const cameraGroupDiv = document.createElement('div');
        cameraGroupDiv.className = 'permission-group';
        cameraGroupDiv.innerHTML = `<h4>Quy·ªÅn xem Camera</h4>`;
        db.cameras.forEach(camera => {
            const isChecked = targetPermissions.cameras && targetPermissions.cameras.includes(camera.id) ? 'checked' : '';
            cameraGroupDiv.innerHTML += `
                <div class="permission-item">
                    <input type="checkbox" id="camera_perm_${camera.id}" data-camera-id="${camera.id}" ${isChecked}>
                    <label for="camera_perm_${camera.id}">${camera.name}</label>
                </div>`;
        });
        container.appendChild(cameraGroupDiv);


        if (type === 'user') {
            passwordResetContainer.style.display = 'block';
        }

        container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const moduleId = e.target.getAttribute('data-module');
                const cameraId = parseInt(e.target.getAttribute('data-camera-id')); 
                const isChecked = e.target.checked;

                if (type === 'user') {
                    if (!db.permissions.users[id]) {
                        db.permissions.users[id] = { ...db.permissions.roles[db.users.find(u=>u.id==id).role] };
                    }
                    if (moduleId) { 
                        db.permissions.users[id][moduleId] = isChecked;
                    } else if (cameraId) { 
                        if (!db.permissions.users[id].cameras) {
                            db.permissions.users[id].cameras = [];
                        }
                        if (isChecked && !db.permissions.users[id].cameras.includes(cameraId)) {
                            db.permissions.users[id].cameras.push(cameraId);
                        } else if (!isChecked) {
                            db.permissions.users[id].cameras = db.permissions.users[id].cameras.filter(c => c !== cameraId);
                        }
                    }
                } else { 
                    if (moduleId) {
                        db.permissions.roles[id][moduleId] = isChecked;
                    } else if (cameraId) {
                        if (!db.permissions.roles[id].cameras) {
                            db.permissions.roles[id].cameras = [];
                        }
                        if (isChecked && !db.permissions.roles[id].cameras.includes(cameraId)) {
                            db.permissions.roles[id].cameras.push(cameraId);
                        } else if (!isChecked) {
                            db.permissions.roles[id].cameras = db.permissions.roles[id].cameras.filter(c => c !== cameraId);
                        }
                    }
                }
                showSuccessMessage('permissionSuccessMessage', '‚úÖ ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!');
                if (currentUser.role === 'principal' || currentUser.id == id) {
                    renderCameras();
                }
            });
        });
    };
    
    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi ƒë·ªëi t∆∞·ª£ng ph√¢n quy·ªÅn ƒë·ªÉ render l·∫°i ma tr·∫≠n
    document.getElementById('permissionTarget').addEventListener('change', renderPermissionMatrix);
    
    // X·ª≠ l√Ω submit form gi√°o vi√™n
    document.getElementById('teacherForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const teacherId = Date.now(), teacherName = document.getElementById('teacherName').value;
        db.teachers.push({ 
            id: teacherId, name: teacherName, phone: document.getElementById('teacherPhone').value,
            cccd: document.getElementById('teacherCCCD').value, address: document.getElementById('teacherAddress').value,
            assignedClass: document.getElementById('teacherClass').value 
        });
        db.users.push({
            id: Date.now() + 1, username: document.getElementById('teacherUsername').value, password: document.getElementById('teacherPassword').value,
            role: 'teacher', name: teacherName, linkedId: teacherId
        });
        renderAll(); 
        e.target.reset();
        document.getElementById('teacherFormContainer').style.display = 'none'; // Hide form after submission
        showSuccessMessage('teacherSuccessMessage', '‚úÖ ƒê√£ l∆∞u h·ªì s∆° v√† t·∫°o t√†i kho·∫£n gi√°o vi√™n th√†nh c√¥ng!');
    });
    
    // X·ª≠ l√Ω submit form tr·∫ª em
    document.getElementById('childForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const childId = Date.now(), password = document.getElementById('parentPassword').value;
        const fatherPhone = document.getElementById('fatherPhone').value, motherPhone = document.getElementById('motherPhone').value;
        const childName = document.getElementById('childName').value;
        db.children.push({
            id: childId, name: childName, birthDate: document.getElementById('childBirthDate').value,
            gender: document.getElementById('childGender').value, class: document.getElementById('childClassChild').value,
            address: document.getElementById('childAddress').value, health: document.getElementById('childHealth').value,
            allergies: document.getElementById('childAllergies').value,
            emergencyContactName: document.getElementById('emergencyContactName').value, emergencyContactPhone: document.getElementById('emergencyContactPhone').value
        });
        db.parents.push({
            id: Date.now() + 1, fatherName: document.getElementById('fatherName').value, motherName: document.getElementById('motherName').value,
            fatherPhone: fatherPhone, motherPhone: motherPhone, email: document.getElementById('parentEmail').value, childId: childId
        });
        const username = fatherPhone || motherPhone;
        if (password && username) {
            db.users.push({
                id: Date.now() + 2, username: username, password: password,
                role: 'parent', name: `PH b√© ${childName}`, linkedId: childId
            });
        }
        renderAll(); 
        e.target.reset();
        document.getElementById('childFormContainer').style.display = 'none'; // Hide form after submission
        showSuccessMessage('childSuccessMessage', '‚úÖ ƒê√£ l∆∞u h·ªì s∆° th√†nh c√¥ng!');
    });
    
    // X·ª≠ l√Ω submit form ghi ch√∫
    document.getElementById('noteForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const content = document.getElementById('noteContent').value;
        const newNote = {
            id: Date.now(),
            content: content,
            createdBy: currentUser.name,
            createdAt: new Date().toLocaleDateString('vi-VN')
        };
        db.notes.push(newNote);
        renderNotes();
        e.target.reset();
        showSuccessMessage('noteSuccessMessage', '‚úÖ ƒê√£ th√™m ghi ch√∫ th√†nh c√¥ng!');
    });

    // X·ª≠ l√Ω ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u
    document.getElementById('resetPasswordBtn').addEventListener('click', () => {
        const target = document.getElementById('permissionTarget').value;
        const newPassword = document.getElementById('newPasswordForUser').value;
        if (!target || !newPassword || !target.startsWith('user_')) {
            const modalMessage = document.createElement('div');
            modalMessage.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
                z-index: 1000; text-align: center;
            `;
            modalMessage.innerHTML = `
                <p>Vui l√≤ng ch·ªçn m·ªôt t√†i kho·∫£n v√† nh·∫≠p m·∫≠t kh·∫©u m·ªõi.</p>
                <button onclick="this.parentNode.remove()">ƒê√≥ng</button>
            `;
            document.body.appendChild(modalMessage);
            return;
        }

        const userId = parseInt(target.split('_')[1]);
        const user = db.users.find(u => u.id === userId);
        if (user) {
            user.password = newPassword;
            document.getElementById('newPasswordForUser').value = '';
            showSuccessMessage('permissionSuccessMessage', `‚úÖ ƒê√£ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho t√†i kho·∫£n ${user.username} th√†nh c√¥ng!`);
        }
    });

    // C√°c h√†m x√≥a d·ªØ li·ªáu
    window.deleteTeacher = (id) => { 
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; text-align: center;
        `;
        modal.innerHTML = `
            <p>X√≥a gi√°o vi√™n? T√†i kho·∫£n li√™n k·∫øt c≈©ng s·∫Ω b·ªã x√≥a.</p>
            <button class="btn btn-danger" onclick="window.confirmAction(true, ${id}, 'teacher')">X√°c nh·∫≠n</button>
            <button class="btn" onclick="window.confirmAction(false)">H·ªßy</button>
        `;
        document.body.appendChild(modal);
    };

    window.deleteChild = (id) => { 
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; text-align: center;
        `;
        modal.innerHTML = `
            <p>X√≥a tr·∫ª? To√†n b·ªô th√¥ng tin ph·ª• huynh v√† t√†i kho·∫£n li√™n k·∫øt s·∫Ω b·ªã x√≥a.</p>
            <button class="btn btn-danger" onclick="window.confirmAction(true, ${id}, 'child')">X√°c nh·∫≠n</button>
            <button class="btn" onclick="window.confirmAction(false)">H·ªßy</button>
        `;
        document.body.appendChild(modal);
    };

    window.deleteUser = (id) => { 
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; text-align: center;
        `;
        modal.innerHTML = `
            <p>X√≥a t√†i kho·∫£n?</p>
            <button class="btn btn-danger" onclick="window.confirmAction(true, ${id}, 'user')">X√°c nh·∫≠n</button>
            <button class="btn" onclick="window.confirmAction(false)">H·ªßy</button>
        `;
        document.body.appendChild(modal);
    };

    window.deleteNote = (id) => { 
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; text-align: center;
        `;
        modal.innerHTML = `
            <p>X√≥a ghi ch√∫ n√†y?</p>
            <button class="btn btn-danger" onclick="window.confirmAction(true, ${id}, 'note')">X√°c nh·∫≠n</button>
            <button class="btn" onclick="window.confirmAction(false)">H·ªßy</button>
        `;
        document.body.appendChild(modal);
    };

    // H√†m x·ª≠ l√Ω x√°c nh·∫≠n t·ª´ modal t√πy ch·ªânh
    window.confirmAction = (confirmed, id, type) => {
        const modal = document.querySelector('body > div[style*="position: fixed"]'); 
        if (modal) modal.remove(); 

        if (confirmed) {
            if (type === 'teacher') {
                db.teachers = db.teachers.filter(t=>t.id!==id);
                db.users = db.users.filter(u=>!(u.role==='teacher' && u.linkedId===id));
            } else if (type === 'child') {
                db.children = db.children.filter(c=>c.id!==id);
                db.parents = db.parents.filter(p=>p.childId!==id);
                db.users = db.users.filter(u=>!(u.role==='parent' && u.linkedId===id));
            } else if (type === 'user') {
                db.users = db.users.filter(u=>u.id!==id);
            } else if (type === 'note') {
                db.notes = db.notes.filter(n=>n.id!==id);
                renderNotes(); 
                return; 
            }
            renderAll();
        }
    };

    // Hi·ªÉn th·ªã tab
    window.showTab = (tabName) => {
        const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
        if(!tabButton || tabButton.style.display === 'none') return;
        document.querySelectorAll('.tab-content, .nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        tabButton.classList.add('active');
        // Reset form visibility when switching tabs
        if (tabName === 'teachers') {
            document.getElementById('teacherFormContainer').style.display = 'none';
        } else if (tabName === 'children') {
            document.getElementById('childFormContainer').style.display = 'none';
            document.getElementById('aiChildReportContainer').style.display = 'none'; // Also hide AI report
        }
    };

    // ƒêƒÉng xu·∫•t
    window.logout = () => {
        currentUser = null;
        mainApp.style.display = 'none';
        loginScreen.style.display = 'flex';
    };

    // L·∫Øng nghe s·ª± ki·ªán submit form ƒëƒÉng nh·∫≠p
    document.getElementById('loginForm').addEventListener('submit', handleLogin);

    // L·∫Øng nghe s·ª± ki·ªán click n√∫t "+ Th√™m Gi√°o Vi√™n"
    document.getElementById('addTeacherBtn').addEventListener('click', () => {
        const formContainer = document.getElementById('teacherFormContainer');
        formContainer.style.display = formContainer.style.display === 'block' ? 'none' : 'block';
    });

    // L·∫Øng nghe s·ª± ki·ªán click n√∫t "+ Th√™m Tr·∫ª"
    document.getElementById('addChildBtn').addEventListener('click', () => {
        const formContainer = document.getElementById('childFormContainer');
        formContainer.style.display = formContainer.style.display === 'block' ? 'none' : 'block';
        document.getElementById('aiChildReportContainer').style.display = 'none'; // Hide AI report when showing form
    });

    // H√†m t·∫°o b√°o c√°o AI cho tr·∫ª
    window.generateChildReport = async (childId) => {
        const child = db.children.find(c => c.id === childId);
        const parentInfo = db.parents.find(p => p.childId === childId);
        const aiReportContainer = document.getElementById('aiChildReportContainer');
        
        if (!child) {
            aiReportContainer.innerHTML = '<p style="color: red;">Kh√¥ng t√¨m th·∫•y th√¥ng tin tr·∫ª.</p>';
            aiReportContainer.style.display = 'block';
            return;
        }

        // Display loading indicator
        aiReportContainer.innerHTML = `<div class="ai-report-loading">ƒêang t·∫°o b√°o c√°o cho b√© ${child.name}... ‚ú®</div>`;
        aiReportContainer.style.display = 'block';

        const prompt = `T·∫°o m·ªôt b√°o c√°o t√≥m t·∫Øt ph√°t tri·ªÉn cho tr·∫ª m·∫ßm non d·ª±a tr√™n th√¥ng tin sau:
        T√™n: ${child.name}
        Ng√†y sinh: ${child.birthDate}
        Gi·ªõi t√≠nh: ${child.gender}
        L·ªõp: ${child.class}
        T√¨nh tr·∫°ng s·ª©c kh·ªèe: ${child.health || 'B√¨nh th∆∞·ªùng'}
        D·ªã ·ª©ng: ${child.allergies || 'Kh√¥ng c√≥'}
        Ng∆∞·ªùi li√™n h·ªá kh·∫©n c·∫•p: ${child.emergencyContactName || 'Kh√¥ng c√≥'} - ${child.emergencyContactPhone || ''}
        Th√¥ng tin ph·ª• huynh: Cha - ${parentInfo.fatherName || 'N/A'}, M·∫π - ${parentInfo.motherName || 'N/A'}, Email: ${parentInfo.email || 'N/A'}.

        B√°o c√°o n√™n t·∫≠p trung v√†o c√°c ƒëi·ªÉm m·∫°nh, kh·∫£ nƒÉng ph√°t tri·ªÉn, v√† ƒë∆∞a ra nh·ªØng g·ª£i √Ω t√≠ch c·ª±c, chuy√™n nghi·ªáp. ƒê·ªô d√†i kho·∫£ng 150-200 t·ª´, ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng th√†nh c√°c ƒëo·∫°n vƒÉn r√µ r√†ng.`;

        try {
            const chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                aiReportContainer.innerHTML = `
                    <h3>B√°o c√°o ph√°t tri·ªÉn c·ªßa b√© ${child.name} (AI t·∫°o)</h3>
                    <div class="ai-report-content">${text.replace(/\n/g, '<br>')}</div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="document.getElementById('aiChildReportContainer').style.display = 'none';">ƒê√≥ng b√°o c√°o</button>
                `;
            } else {
                aiReportContainer.innerHTML = `<p style="color: red;">Kh√¥ng th·ªÉ t·∫°o b√°o c√°o AI. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
            }
        } catch (error) {
            console.error("Error generating AI report:", error);
            aiReportContainer.innerHTML = `<p style="color: red;">ƒê√£ x·∫£y ra l·ªói khi t·∫°o b√°o c√°o AI. Chi ti·∫øt l·ªói: ${error.message}</p>`;
        }
    };
});
</script>
</body>
</html>
