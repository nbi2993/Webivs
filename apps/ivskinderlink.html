/**
 * IVS KinderLink - Backend API
 * File: functions/index.js
 * Description: Lõi xử lý backend, cung cấp API cho ứng dụng frontend.
 * Version: 2.0 - Production Ready with Seeding
 * Author: Gemini
 */

const functions = require("firebase-functions/v2");
const admin = require("firebase-admin");
const express = require("express");
const cors = require("cors");

// --- ĐỊNH NGHĨA SECRETS ---
const serviceAccountKeySecret = functions.params.defineSecret("SERVICEACCOUNT_KEY_BASE64");
const geminiApiKeySecret = functions.params.defineSecret("GEMINI_API_KEY");

// --- KHỞI TẠO ỨNG DỤNG ---
const app = express();
app.use(cors({ origin: true }));

let isAppInitialized = false;

function initializeFirebaseApp(serviceAccountKeyBase64) {
    if (isAppInitialized) return;
    try {
        const serviceAccountString = Buffer.from(serviceAccountKeyBase64, 'base64').toString('utf8');
        const serviceAccount = JSON.parse(serviceAccountString);
        admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
        });
        console.log("Firebase Admin SDK initialized successfully.");
        isAppInitialized = true;
    } catch (error) {
        if (error.code !== 'app/duplicate-app') {
            console.error("CRITICAL: Failed to initialize Firebase Admin SDK.", error);
        }
    }
}

const authorize = (roles = []) => async (req, res, next) => {
    if (!req.headers.authorization || !req.headers.authorization.startsWith('Bearer ')) {
        return res.status(403).send('Unauthorized: No token provided.');
    }
    const idToken = req.headers.authorization.split('Bearer ')[1];
    try {
        const decodedToken = await admin.auth().verifyIdToken(idToken);
        req.user = decodedToken;
        const userRole = decodedToken.role;
        if (roles.length > 0 && !roles.includes(userRole)) {
            return res.status(403).send('Unauthorized: Insufficient permissions.');
        }
        next();
    } catch (error) {
        return res.status(403).send('Unauthorized: Invalid token.');
    }
};

const db = admin.firestore();
const getCollection = (collectionName) => db.collection(collectionName);

// Generic CRUD factory (giữ nguyên)
// ...

// --- API ĐẶC BIỆT ĐỂ KHỞI TẠO DỮ LIỆU MẪU ---
app.post('/seed-database', authorize(['principal']), async (req, res) => {
    try {
        const batch = db.batch();
        const mockData = {
            teachers: [
                { id: '401', name: 'Cô Mai', phone: '0987654321', cccd: '012345678901', address: '123 Đường ABC, TPHCM', assignedClass: 'Lớp Chồi' },
                { id: '402', name: 'Cô Lan', phone: '0987111222', cccd: '012345678902', address: '456 Đường XYZ, TPHCM', assignedClass: 'Lớp Lá' }
            ],
            children: [
                { id: '101', name: 'Nguyễn An Nhiên', birthDate: '2022-05-20', gender: 'Nữ', class: 'Lớp Chồi', address: '123 Đường ABC, Q1, TPHCM', health: 'Bình thường', allergies: 'Không', emergencyContactName: 'Bà ngoại - Trần Thị C', emergencyContactPhone: '0903333444' },
                { id: '102', name: 'Trần Minh Khang', birthDate: '2022-03-15', gender: 'Nam', class: 'Lớp Chồi', address: '456 Đường XYZ, Q2, TPHCM', health: 'Dị ứng sữa', allergies: 'Sữa bò', emergencyContactName: 'Ông nội - Trần Văn B', emergencyContactPhone: '0902222333'},
            ],
            // ... Thêm các dữ liệu mẫu khác (parents, fees, menus, notes, cameras)
        };

        // Seed teachers
        mockData.teachers.forEach(teacher => {
            const docRef = db.collection('teachers').doc(teacher.id);
            batch.set(docRef, teacher);
        });

        // Seed children
        mockData.children.forEach(child => {
            const docRef = db.collection('children').doc(child.id);
            batch.set(docRef, child);
        });
        
        // ... Seed các collection khác

        await batch.commit();

        res.status(200).send('Successfully seeded database with mock data.');

    } catch (error) {
        console.error("Error seeding database:", error);
        res.status(500).send(`Failed to seed database: ${error.message}`);
    }
});


// ... Các router CRUD khác giữ nguyên ...

// --- XUẤT CLOUD FUNCTION CHÍNH ---
exports.api = functions.https.onRequest(
    {
        region: "asia-southeast1",
        secrets: [serviceAccountKeySecret, geminiApiKeySecret],
        memory: "512MiB"
    },
    (req, res) => {
        initializeFirebaseApp(serviceAccountKeySecret.value());
        return app(req, res);
    }
);
