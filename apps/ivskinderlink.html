<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVS KinderLink</title>
    <!-- Thay thế toàn bộ thẻ <style> bằng file CSS ngoài trong thực tế -->
    <style>
        /* Toàn bộ CSS từ file prototype được giữ nguyên ở đây */
        /* ... */
        .modal { display: none; /* ... */ }
        .modal.is-active { display: flex; }
    </style>
</head>
<body>
    <!-- Toàn bộ cấu trúc HTML từ file prototype được giữ nguyên -->
    <!-- ... -->

    <!-- Modal cho việc Chỉnh sửa -->
    <div id="editModal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <h3 id="editModalTitle">Chỉnh sửa thông tin</h3>
                <div id="editFormContainer"></div>
                <button id="closeEditModal" class="button">Đóng</button>
            </div>
        </div>
    </div>


<script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdToken } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";

    // --- CONFIGURATION ---
    // Sửa lỗi: Tự động lấy cấu hình Firebase từ môi trường Canvas
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
    const API_BASE_URL = "https://asia-southeast1-ivsjsc-6362f.cloudfunctions.net/api"; // URL của API sau khi deploy

    // --- INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- STATE MANAGEMENT ---
    let currentUser = null;
    let idToken = null;

    // --- UI ELEMENTS ---
    const ui = {
        loginScreen: document.getElementById('loginScreen'),
        mainApp: document.getElementById('mainApp'),
        // ... các element khác
    };

    // --- API SERVICE ---
    const api = {
        async get(endpoint) {
            const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${idToken}` }
            });
            return res.json();
        },
        async post(endpoint, body) {
            const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify(body)
            });
            return res.json();
        },
        // ... thêm put, delete
    };

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            idToken = await getIdToken(user);
            // Lấy vai trò từ token
            const decodedToken = JSON.parse(atob(idToken.split('.')[1]));
            currentUser.role = decodedToken.role || 'parent';
            
            ui.loginScreen.style.display = 'none';
            ui.mainApp.style.display = 'block';
            setupApp(); 
        } else {
            currentUser = null;
            idToken = null;
            ui.mainApp.style.display = 'none';
            ui.loginScreen.style.display = 'flex';
        }
    });
    
    // --- APP LOGIC ---
    
    async function setupApp() {
        // Setup UI theo quyền
        setupPermissions();
        // Render dashboard
        await renderDashboard();
        // Gắn các event listeners
        attachEventListeners();
    }

    async function renderTeachersTable() {
        const teachers = await api.get('/teachers');
        const tableBody = document.getElementById('teachersTableBody');
        tableBody.innerHTML = '';
        teachers.forEach(teacher => {
            // ... tạo row
            // Thêm nút Edit
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Sửa';
            editBtn.onclick = () => openEditModal('teacher', teacher);
            // ...
        });
    }
    
    // ... các hàm render khác được viết lại để dùng `api.get`

    function openEditModal(type, data) {
        // Mở modal, tạo form chỉnh sửa dựa trên `type` và `data`
    }
    
    // ...

    // --- EVENT LISTENERS ---
    function attachEventListeners() {
        // Gắn sự kiện cho các nút thêm, sửa, xóa
        // Ví dụ:
        document.getElementById('teacherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newTeacher = { /* ... lấy data từ form ... */ };
            await api.post('/teachers', newTeacher);

            // Làm mới bảng
            await renderTeachersTable();
        });
    }

</script>
</body>
</html>
