<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="page_title_teacher_hub">IVS Global Teacher Hub - Nền tảng cho Giáo viên Quốc tế</title>
    <meta name="description" content="Tham gia IVS Global Teacher Hub - Cộng đồng tinh hoa các nhà giáo quốc tế. Khám phá cơ hội giảng dạy, phát triển sự nghiệp và hợp tác giáo dục toàn cầu với IVS JSC." data-lang-key="meta_description_teacher_hub_enhanced">
    <meta name="keywords" content="IVS JSC, trung tâm giáo viên, giáo viên toàn cầu, việc làm giảng dạy tại Việt Nam, giáo dục quốc tế, ứng tuyển giảng dạy, nghề nghiệp EdTech, việc làm ESL" data-lang-key="meta_keywords_teacher_hub_enhanced">
    <meta property="og:title" content="IVS Global Teacher Hub - Kết nối Tài năng, Định hình Tương lai Giáo dục" data-lang-key="og_title_teacher_hub_enhanced">
    <meta property="og:description" content="IVS Global Teacher Hub tập hợp các nhà giáo quốc tế xuất sắc, mang đến cơ hội phát triển chuyên môn và giảng dạy trong các dự án giáo dục hàng đầu của IVS JSC." data-lang-key="og_description_teacher_hub_enhanced">
    <meta property="og:image" content="https://placehold.co/1200x630/004080/FFFFFF?text=IVS+Teacher+Hub">
    <meta property="og:url" content="https://ivsacademy.edu.vn/apps/ivs-global-teacher-hub.html">
    <meta property="og:type" content="website">
    <meta name="author" content="IVS JSC">

    <link rel="icon" href="https://placehold.co/32x32/004080/FFFFFF?text=IVS" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/004080/FFFFFF?text=IVS">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Google Fonts: Inter and Lexend for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Lexend', 'sans-serif'],
                    },
                    colors: {
                        'ivs-primary': '#004080', 
                        'ivs-primary-dark': '#003366',
                        'ivs-primary-light': '#0059b3',
                        'ivs-secondary': '#ffc107', 
                        'ivs-secondary-dark': '#e0a800',
                        'ivs-accent': '#F97316', 
                        'ivs-accent-dark': '#DD6B20',
                        'ivs-neutral-900': '#111827',
                        'ivs-neutral-800': '#1f2937',
                        'ivs-neutral-700': '#374151',
                        'ivs-neutral-600': '#4B5563',
                        'ivs-neutral-500': '#6B7280',
                        'ivs-neutral-400': '#9CA3AF',
                        'ivs-neutral-300': '#D1D5DB',
                        'ivs-neutral-200': '#E5E7EB',
                        'ivs-neutral-100': '#F3F4F6',
                        'ivs-neutral-50': '#F9FAFB', 
                        'ivs-success': '#10B981',
                        'ivs-success-dark': '#059669',
                        'ivs-warning': '#F59E0B',
                        'ivs-danger': '#EF4444',
                        'ivs-info': '#3B82F6',
                    }
                }
            },
            plugins: [],
        }
    </script>

    <!-- AOS for scroll animations -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css"> 
    <style>
        /* Custom styles for the app */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, .font-display { font-family: 'Lexend', sans-serif; }
        
        .hub-app-container {
            background-color: theme('colors.ivs-neutral-50');
            width: 100%;
            min-height: calc(100vh - var(--header-height, 60px) - var(--footer-height, 60px));
        }
        .dark .hub-app-container { background-color: theme('colors.ivs-neutral-900'); }

        .tab-button {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.15s ease-in-out;
            border-bottom: 4px solid transparent;
            padding-top: 0.75rem; padding-bottom: 0.75rem; 
        }
        .tab-button:hover {
            background-color: theme('colors.ivs-neutral-100');
            color: theme('colors.ivs-primary-dark');
        }
        .dark .tab-button:hover {
            background-color: theme('colors.ivs-neutral-700');
            color: theme('colors.ivs-secondary');
        }
        .tab-button-active {
            color: theme('colors.ivs-primary') !important;
            border-bottom-color: theme('colors.ivs-primary') !important;
            font-weight: 700;
        }
        .dark .tab-button-active {
             color: theme('colors.ivs-secondary') !important;
             border-bottom-color: theme('colors.ivs-secondary') !important;
        }

        .form-input, .form-textarea, .form-select {
            background-color: theme('colors.white');
            border-color: theme('colors.ivs-neutral-300');
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            padding: 0.75rem 1rem; 
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: theme('colors.ivs-primary');
            box-shadow: 0 0 0 3px theme('colors.ivs-primary / 20%');
            outline: none;
        }
        .dark .form-input, .dark .form-textarea, .dark .form-select {
            background-color: theme('colors.ivs-neutral-700');
            border-color: theme('colors.ivs-neutral-600');
            color: theme('colors.ivs-neutral-100');
        }
        .dark .form-input::placeholder, .dark .form-textarea::placeholder { color: theme('colors.ivs-neutral-400'); }
        .dark .form-input:focus, .dark .form-textarea:focus, .dark .form-select:focus {
            border-color: theme('colors.ivs-secondary');
            box-shadow: 0 0 0 3px theme('colors.ivs-secondary / 25%');
        }
        label.required::after {
            content: '*';
            color: theme('colors.ivs-danger');
            margin-left: 0.25rem;
        }
                
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-panel { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-in-out; }
        .modal-panel.entering { opacity: 0; transform: translateY(30px) scale(0.95); }
        .modal-panel.entered { opacity: 1; transform: translateY(0) scale(1); }
        .modal-panel.exiting { opacity: 0; transform: translateY(30px) scale(0.95); }

        /* Loading placeholders for header/footer */
        #header-placeholder:empty, #footer-placeholder:empty { min-height: 60px; background-color: theme('colors.ivs-neutral-100'); display: flex; align-items: center; justify-content: center; }
        .dark #header-placeholder:empty, .dark #footer-placeholder:empty { background-color: theme('colors.ivs-neutral-800'); }
        #header-placeholder:empty::before, #footer-placeholder:empty::before { content: attr(data-loading-text); color: theme('colors.ivs-neutral-500'); font-style: italic; }
    </style>
</head>
<body class="bg-ivs-neutral-50 dark:bg-ivs-neutral-900 text-ivs-neutral-700 dark:text-ivs-neutral-200 antialiased" id="page-teacher-hub">
    
    <!-- Placeholder for header component -->
    <div id="header-placeholder" data-loading-text="Đang tải menu..."></div>

    <!-- Global loading spinner -->
    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-white/70 dark:bg-ivs-neutral-900/70 backdrop-blur-md z-[1100] hidden transition-opacity duration-300">
        <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-b-4 border-ivs-primary dark:border-ivs-secondary"></div>
        <p class="ml-4 text-lg font-medium text-ivs-primary dark:text-ivs-secondary" data-lang-key="loading_text">Đang xử lý...</p>
    </div>

    <!-- Custom Modal for alerts/confirmations -->
    <div id="custom-modal" class="fixed inset-0 z-[1050] overflow-y-auto hidden modal-backdrop bg-ivs-neutral-900/60 dark:bg-black/75">
        <div class="flex items-end sm:items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="modal-panel entering inline-block w-full max-w-md p-6 sm:p-8 my-8 overflow-hidden text-left align-middle transition-all transform bg-white dark:bg-ivs-neutral-800 shadow-2xl rounded-xl">
                <div class="flex items-start">
                    <div id="modal-icon-container" class="flex-shrink-0 flex items-center justify-center h-10 w-10 sm:h-12 sm:w-12 rounded-full mr-3 sm:mr-4">
                        <!-- Icon will be dynamically added here -->
                    </div>
                    <div class="flex-grow">
                        <h3 id="modal-title" class="text-xl font-display font-semibold leading-6 text-ivs-neutral-900 dark:text-white" data-lang-key="modal_default_title">Thông báo</h3>
                        <div class="mt-2">
                            <p id="modal-message" class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-300" data-lang-key="modal_default_message">Chi tiết tại đây.</p>
                        </div>
                    </div>
                    <button id="modal-close-button-x" type="button" class="ml-auto -mr-2 -mt-2 p-2 text-ivs-neutral-400 hover:text-ivs-neutral-600 dark:text-ivs-neutral-500 dark:hover:text-ivs-neutral-300 rounded-full focus:outline-none focus:ring-2 focus:ring-ivs-primary dark:focus:ring-ivs-secondary" aria-label="Đóng cửa sổ">
                         <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="mt-6 sm:mt-8 flex flex-col sm:flex-row-reverse gap-3">
                    <button id="modal-confirm-button" type="button"
                            class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent bg-ivs-primary px-6 py-2.5 text-base font-medium text-white hover:bg-ivs-primary-dark focus:outline-none focus-visible:ring-2 focus-visible:ring-ivs-primary focus-visible:ring-offset-2 dark:bg-ivs-secondary dark:text-ivs-neutral-900 dark:hover:bg-ivs-secondary-dark dark:focus-visible:ring-ivs-secondary dark:focus-visible:ring-offset-ivs-neutral-800 transition-colors duration-150"
                            data-lang-key="modal_confirm_button">
                        Xác nhận
                    </button>
                    <button id="modal-cancel-button" type="button"
                            class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-ivs-neutral-300 dark:border-ivs-neutral-600 bg-white dark:bg-ivs-neutral-700 px-6 py-2.5 text-base font-medium text-ivs-neutral-700 dark:text-ivs-neutral-200 hover:bg-ivs-neutral-50 dark:hover:bg-ivs-neutral-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-ivs-primary focus-visible:ring-offset-2 dark:focus-visible:ring-ivs-secondary dark:focus-visible:ring-offset-ivs-neutral-800 transition-colors duration-150"
                            data-lang-key="modal_cancel_button">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main application container -->
    <div class="hub-app-container pt-[var(--header-height, 60px)]">
        <header class="py-16 sm:py-20 md:py-24 bg-gradient-to-br from-ivs-primary via-blue-800 to-indigo-700 dark:from-ivs-neutral-800 dark:via-ivs-neutral-900 dark:to-black text-white shadow-xl">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-display font-bold mb-4 leading-tight" data-lang-key="hub_main_title_enhanced">IVS Global Teacher Hub</h1>
                <p class="text-lg sm:text-xl text-blue-100 dark:text-ivs-neutral-300 max-w-3xl mx-auto leading-relaxed" data-lang-key="hub_subtitle_enhanced">
                    Kết nối các nhà giáo quốc tế tài năng với các cơ hội giảng dạy và phát triển sự nghiệp hàng đầu tại IVS JSC.
                </p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white dark:bg-ivs-neutral-800/80 backdrop-blur-sm shadow-md sticky top-[var(--header-height, 60px)] z-40 border-b border-ivs-neutral-200 dark:border-ivs-neutral-700">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-center items-stretch h-14 sm:h-16 space-x-0 sm:space-x-1">
                    <button id="apply-tab-button" 
                            class="tab-button flex-1 sm:flex-none px-4 sm:px-8 py-2 text-sm font-medium rounded-t-lg tab-button-active" 
                            data-lang-key="hub_tab_apply">
                        <i class="fas fa-user-plus mr-1.5 sm:mr-2 text-base"></i>Đăng ký Giáo viên
                    </button>
                    <button id="view-teachers-tab-button"
                            class="tab-button flex-1 sm:flex-none px-4 sm:px-8 py-2 text-sm font-medium rounded-t-lg text-ivs-neutral-700 dark:text-ivs-neutral-300 hover:text-ivs-primary-dark dark:hover:text-ivs-secondary flex items-center justify-center" 
                            data-lang-key="hub_tab_view_teachers">
                        <i class="fas fa-users mr-1.5 sm:mr-2 text-base"></i>Xem Danh sách Giáo viên
                    </button>
                    <button id="my-profile-tab-button"
                            class="tab-button flex-1 sm:flex-none px-4 sm:px-8 py-2 text-sm font-medium rounded-t-lg text-ivs-neutral-700 dark:text-ivs-neutral-300 hover:text-ivs-primary-dark dark:hover:text-ivs-secondary flex items-center justify-center hidden" 
                            data-lang-key="hub_tab_my_profile">
                        <i class="fas fa-address-card mr-1.5 sm:mr-2 text-base"></i>Hồ sơ của tôi
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">
            <!-- User ID Display -->
            <div id="user-id-display" class="text-sm text-ivs-neutral-500 dark:text-ivs-neutral-400 text-center mb-6">
                ID người dùng của bạn: <span id="current-user-id" class="font-mono text-ivs-primary-dark dark:text-ivs-secondary-light">Đang tải...</span>
            </div>

            <!-- Teacher Application/Edit Profile Section -->
            <section id="teacher-application-section" class="max-w-3xl mx-auto" data-aos="fade-up" data-aos-delay="100">
                <header class="mb-8 md:mb-10 text-center">
                    <h2 id="application-form-title" class="text-3xl sm:text-4xl font-display font-semibold text-ivs-primary dark:text-ivs-secondary mb-3" data-lang-key="hub_apply_form_title_enhanced">Trở thành Nhà giáo Quốc tế của IVS</h2>
                    <p id="application-form-description" class="text-ivs-neutral-600 dark:text-ivs-neutral-400 text-sm sm:text-base" data-lang-key="hub_apply_form_desc_enhanced">Hoàn thành biểu mẫu dưới đây để mở khóa các cơ hội nghề nghiệp thú vị. Thông tin của bạn sẽ được lưu trữ an toàn.</p>
                </header>

                <form id="teacher-profile-form" class="space-y-6 sm:space-y-8 bg-white dark:bg-ivs-neutral-800 p-6 sm:p-8 md:p-10 rounded-xl shadow-2xl border border-ivs-neutral-200 dark:border-ivs-neutral-700">
                    <input type="hidden" id="teacher-doc-id" name="teacherDocId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div>
                            <label for="fullName" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_fullName">Họ và tên</label>
                            <input type="text" id="fullName" name="fullName" class="form-input block w-full rounded-lg shadow-sm" placeholder="Ví dụ: John Doe" required>
                        </div>
                        <div>
                            <label for="email" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_email">Địa chỉ Email</label>
                            <input type="email" id="email" name="email" class="form-input block w-full rounded-lg shadow-sm" placeholder="email_cua_ban@example.com" required>
                        </div>
                        <div>
                            <label for="phoneNumber" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_phoneNumber">Số điện thoại</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" class="form-input block w-full rounded-lg shadow-sm" placeholder="+1 123 456 7890" required>
                        </div>
                        <div>
                            <label for="nationality" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_nationality">Quốc tịch</label>
                            <input type="text" id="nationality" name="nationality" class="form-input block w-full rounded-lg shadow-sm" placeholder="Ví dụ: Mỹ, Anh" required>
                        </div>
                        <div>
                            <label for="qualification" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_qualification">Bằng cấp cao nhất</label>
                            <input type="text" id="qualification" name="qualification" class="form-input block w-full rounded-lg shadow-sm" placeholder="Ví dụ: Thạc sĩ Giáo dục, TESOL" required>
                        </div>
                        <div>
                            <label for="experience" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_experience">Số năm kinh nghiệm giảng dạy</label>
                            <input type="number" id="experience" name="experience" class="form-input block w-full rounded-lg shadow-sm" placeholder="Ví dụ: 5" min="0" step="0.5" required>
                        </div>
                    </div>

                    <div>
                        <label for="subjects" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_subjects">Các môn có thể dạy (cách nhau bởi dấu phẩy)</label>
                        <input type="text" id="subjects" name="subjects" class="form-input block w-full rounded-lg shadow-sm" placeholder="Ví dụ: Tiếng Anh tổng quát, IELTS, Toán, Khoa học" required>
                    </div>

                    <div>
                        <label for="bio" class="required block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5" data-lang-key="form_bio">Tiểu sử ngắn (tối đa 1500 ký tự)</label>
                        <textarea id="bio" name="bio" rows="5" class="form-textarea block w-full rounded-lg shadow-sm" placeholder="Nêu bật kinh nghiệm giảng dạy, phong cách và các chứng chỉ liên quan của bạn..." maxlength="1500" required></textarea>
                        <p id="bio-char-count" class="text-xs text-ivs-neutral-500 dark:text-ivs-neutral-400 mt-1 text-right">0/1500</p>
                    </div>

                    <div>
                        <label for="availability" class="block text-sm font-medium text-ivs-neutral-700 dark:text-ivs-neutral-300 mb-1.5">Tình trạng sẵn có</label>
                        <select id="availability" name="availability" class="form-select block w-full rounded-lg shadow-sm">
                            <option value="Available">Sẵn sàng</option>
                            <option value="Limited Availability">Hạn chế sẵn sàng</option>
                            <option value="Not Available">Không sẵn sàng</option>
                        </select>
                    </div>

                    <div class="pt-5">
                        <button type="submit" id="submit-profile-button"
                                class="w-full flex items-center justify-center py-3.5 px-6 border border-transparent rounded-xl shadow-lg text-base font-semibold text-white bg-ivs-accent hover:bg-ivs-accent-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ivs-accent dark:focus:ring-offset-ivs-neutral-800 transition-all duration-200 ease-in-out group transform hover:scale-105 active:scale-95">
                            <i class="fas fa-save mr-2.5"></i>Lưu hồ sơ
                        </button>
                    </div>
                </form>
            </section>

            <!-- Teacher Roster Section -->
            <section id="teacher-roster-section" class="hidden" data-aos="fade-up" data-aos-delay="100">
                <header class="mb-8 md:mb-10 text-center">
                    <h2 class="text-3xl sm:text-4xl font-display font-semibold text-ivs-primary dark:text-ivs-secondary mb-3">Danh sách Giáo viên IVS Global</h2>
                    <p class="text-ivs-neutral-600 dark:text-ivs-neutral-400 text-sm sm:text-base">Duyệt qua danh sách các nhà giáo quốc tế tài năng của chúng tôi.</p>
                </header>

                <!-- Search and Filter -->
                <div class="flex flex-col sm:flex-row gap-4 mb-8">
                    <input type="text" id="teacher-search" placeholder="Tìm kiếm theo tên, môn học, quốc tịch..."
                           class="form-input flex-grow rounded-lg shadow-sm">
                    <select id="teacher-filter-subject" class="form-select rounded-lg shadow-sm min-w-[150px]">
                        <option value="">Tất cả môn học</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                    <select id="teacher-filter-availability" class="form-select rounded-lg shadow-sm min-w-[150px]">
                        <option value="">Tất cả tình trạng</option>
                        <option value="Available">Sẵn sàng</option>
                        <option value="Limited Availability">Hạn chế sẵn sàng</option>
                        <option value="Not Available">Không sẵn sàng</option>
                    </select>
                </div>

                <!-- Teacher List Display -->
                <div id="teacher-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Teacher cards will be rendered here -->
                    <p id="no-teachers-message" class="col-span-full text-center text-ivs-neutral-500 dark:text-ivs-neutral-400">Không tìm thấy giáo viên nào.</p>
                </div>
            </section>

            <!-- My Profile Section - Initially hidden, revealed if user has a profile -->
            <section id="my-profile-section" class="hidden max-w-3xl mx-auto" data-aos="fade-up" data-aos-delay="100">
                <header class="mb-8 md:mb-10 text-center">
                    <h2 class="text-3xl sm:text-4xl font-display font-semibold text-ivs-primary dark:text-ivs-secondary mb-3">Hồ sơ của tôi</h2>
                    <p class="text-ivs-neutral-600 dark:text-ivs-neutral-400 text-sm sm:text-base">Xem và cập nhật thông tin hồ sơ giáo viên của bạn.</p>
                </header>
                <div id="my-profile-display" class="bg-white dark:bg-ivs-neutral-800 p-6 sm:p-8 md:p-10 rounded-xl shadow-2xl border border-ivs-neutral-200 dark:border-ivs-neutral-700 space-y-4">
                    <p class="text-lg font-semibold text-ivs-primary dark:text-ivs-secondary">Tên: <span id="profile-full-name" class="font-normal text-ivs-neutral-700 dark:text-ivs-neutral-200">N/A</span></p>
                    <p>Email: <span id="profile-email">N/A</span></p>
                    <p>Điện thoại: <span id="profile-phone">N/A</span></p>
                    <p>Quốc tịch: <span id="profile-nationality">N/A</span></p>
                    <p>Bằng cấp: <span id="profile-qualification">N/A</span></p>
                    <p>Kinh nghiệm: <span id="profile-experience">N/A</span> năm</p>
                    <p>Các môn dạy: <span id="profile-subjects">N/A</span></p>
                    <p>Tiểu sử: <span id="profile-bio" class="block mt-2">N/A</span></p>
                    <p>Tình trạng: <span id="profile-availability" class="font-medium">N/A</span></p>
                    <div class="mt-6 flex gap-4">
                        <button id="edit-my-profile-button" class="flex-1 py-2.5 px-5 rounded-lg bg-ivs-primary text-white hover:bg-ivs-primary-dark transition-colors duration-150">
                            <i class="fas fa-edit mr-2"></i>Chỉnh sửa hồ sơ
                        </button>
                        <button id="delete-my-profile-button" class="flex-1 py-2.5 px-5 rounded-lg bg-ivs-danger text-white hover:bg-ivs-danger-dark transition-colors duration-150">
                            <i class="fas fa-trash-alt mr-2"></i>Xóa hồ sơ
                        </button>
                    </div>
                </div>
                <div id="no-profile-message" class="hidden text-center mt-8 text-ivs-neutral-500 dark:text-ivs-neutral-400">
                    <p>Bạn chưa có hồ sơ giáo viên. Vui lòng điền vào biểu mẫu "Đăng ký Giáo viên" để tạo hồ sơ của bạn.</p>
                </div>
            </section>

        </div>
    </div>

    <!-- Placeholder for FAB and Footer components -->
    <div id="fab-container-placeholder"></div>
    <div id="footer-placeholder" data-loading-text="Đang tải footer..."></div>
       
    <!-- External JavaScript Libraries -->
    <script src="/js/language.js" defer></script>
    <script src="/js/loadComponents.js" defer></script>
    <script src="/js/script.js" defer></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM elements
        const el = {
            applyTabButton: document.getElementById('apply-tab-button'),
            viewTeachersTabButton: document.getElementById('view-teachers-tab-button'),
            myProfileTabButton: document.getElementById('my-profile-tab-button'),
            teacherApplicationSection: document.getElementById('teacher-application-section'),
            teacherRosterSection: document.getElementById('teacher-roster-section'),
            myProfileSection: document.getElementById('my-profile-section'),
            teacherProfileForm: document.getElementById('teacher-profile-form'),
            loadingSpinner: document.getElementById('loading-spinner'),
            modal: document.getElementById('custom-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmButton: document.getElementById('modal-confirm-button'),
            modalCancelButton: document.getElementById('modal-cancel-button'),
            modalCloseButtonX: document.getElementById('modal-close-button-x'),
            modalIconContainer: document.getElementById('modal-icon-container'),
            bioTextarea: document.getElementById('bio'),
            bioCharCount: document.getElementById('bio-char-count'),
            currentUserIdSpan: document.getElementById('current-user-id'),
            teacherDocIdInput: document.getElementById('teacher-doc-id'),
            submitProfileButton: document.getElementById('submit-profile-button'),
            applicationFormTitle: document.getElementById('application-form-title'),
            applicationFormDescription: document.getElementById('application-form-description'),
            teacherListContainer: document.getElementById('teacher-list-container'),
            noTeachersMessage: document.getElementById('no-teachers-message'),
            teacherSearch: document.getElementById('teacher-search'),
            teacherFilterSubject: document.getElementById('teacher-filter-subject'),
            teacherFilterAvailability: document.getElementById('teacher-filter-availability'),
            profileFullName: document.getElementById('profile-full-name'),
            profileEmail: document.getElementById('profile-email'),
            profilePhone: document.getElementById('profile-phone'),
            profileNationality: document.getElementById('profile-nationality'),
            profileQualification: document.getElementById('profile-qualification'),
            profileExperience: document.getElementById('profile-experience'),
            profileSubjects: document.getElementById('profile-subjects'),
            profileBio: document.getElementById('profile-bio'),
            profileAvailability: document.getElementById('profile-availability'),
            editMyProfileButton: document.getElementById('edit-my-profile-button'),
            deleteMyProfileButton: document.getElementById('delete-my-profile-button'),
            myProfileDisplay: document.getElementById('my-profile-display'),
            noProfileMessage: document.getElementById('no-profile-message'),
        };

        let app;
        let db;
        let auth;
        let currentUserId = 'Đang tải...'; // Global variable for user ID
        let userTeacherDocId = null; // Stores the Firestore document ID for the current user's teacher profile
        let allTeachers = []; // Cache for all teachers fetched from Firestore
        let teacherProfileListener = null; // To manage the Firestore listener for the user's profile
        let teacherListListener = null; // To manage the Firestore listener for the teacher list

        // --- Utility Functions ---

        /**
         * Shows a custom modal with dynamic content and buttons.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content of the modal (can contain HTML).
         * @param {string} [type='info'] - Type of modal ('info', 'success', 'error', 'warning').
         * @param {object} [options={}] - Options for buttons and callbacks.
         * @param {boolean} [options.showConfirm=false] - Whether to show the confirm button.
         * @param {string} [options.confirmText='Xác nhận'] - Text for the confirm button.
         * @param {function} [options.onConfirm=() => {}] - Callback for confirm button click.
         * @param {boolean} [options.showCancel=false] - Whether to show the cancel button.
         * @param {string} [options.cancelText='Hủy'] - Text for the cancel button.
         * @param {function} [options.onCancel=() => {}] - Callback for cancel button click.
         */
        function showAppModal(title, message, type = 'info', { showConfirm = false, confirmText = 'Xác nhận', onConfirm = () => {}, showCancel = false, cancelText = 'Hủy', onCancel = () => {} } = {}) {
            if (el.modalTitle) el.modalTitle.textContent = title;
            if (el.modalMessage) el.modalMessage.innerHTML = message; 

            if (el.modalIconContainer) {
                let iconClass = 'fas fa-info-circle';
                let iconBgColorClass = 'bg-ivs-info/10 dark:bg-ivs-info/20';
                let iconTextColorClass = 'text-ivs-info';
                if (type === 'success') { iconClass = 'fas fa-check-circle'; iconBgColorClass = 'bg-ivs-success/10 dark:bg-ivs-success/20'; iconTextColorClass = 'text-ivs-success'; }
                else if (type === 'error') { iconClass = 'fas fa-times-circle'; iconBgColorClass = 'bg-ivs-danger/10 dark:bg-ivs-danger/20'; iconTextColorClass = 'text-ivs-danger'; } 
                else if (type === 'warning') { iconClass = 'fas fa-exclamation-triangle'; iconBgColorClass = 'bg-ivs-warning/10 dark:bg-ivs-warning/20'; iconTextColorClass = 'text-ivs-warning'; }
                el.modalIconContainer.className = `flex-shrink-0 flex items-center justify-center h-10 w-10 sm:h-12 sm:w-12 rounded-full mr-3 sm:mr-4 ${iconBgColorClass}`;
                el.modalIconContainer.innerHTML = `<i class="${iconClass} text-xl sm:text-2xl ${iconTextColorClass}"></i>`;
            }
            
            el.modalConfirmButton.classList.toggle('hidden', !showConfirm);
            el.modalConfirmButton.textContent = confirmText;
            el.modalConfirmButton.onclick = () => { onConfirm(); hideAppModal(); };

            el.modalCancelButton.classList.toggle('hidden', !showCancel);
            el.modalCancelButton.textContent = cancelText;
            el.modalCancelButton.onclick = () => { onCancel(); hideAppModal(); };
            
            // Adjust button width based on visibility
            if(showConfirm && !showCancel) {
                el.modalConfirmButton.classList.add('w-full', 'sm:w-auto');
            } else {
                 el.modalConfirmButton.classList.remove('w-full');
                 el.modalConfirmButton.classList.add('sm:w-auto');
            }

            if (el.modal) {
                 el.modal.classList.remove('hidden');
                 const panel = el.modal.querySelector('.modal-panel');
                 if(panel) {
                    panel.classList.remove('exiting', 'opacity-0', 'scale-95', 'translate-y-5');
                    panel.classList.add('entering');
                    requestAnimationFrame(() => {
                        panel.classList.remove('entering');
                        panel.classList.add('entered', 'opacity-100', 'scale-100', 'translate-y-0');
                    });
                 }
            }
        }

        /**
         * Hides the custom modal.
         */
        function hideAppModal() {
            if (el.modal) {
                const panel = el.modal.querySelector('.modal-panel');
                if(panel) {
                    panel.classList.remove('entered', 'opacity-100', 'scale-100', 'translate-y-0');
                    panel.classList.add('exiting');
                    setTimeout(() => { el.modal.classList.add('hidden'); panel.classList.remove('exiting');}, 300);
                } else { el.modal.classList.add('hidden');}
            }
        }
        
        /**
         * Toggles the visibility of the global loading spinner.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleLoadingSpinner(show) {
            if(el.loadingSpinner) {
                if(show) {
                    el.loadingSpinner.classList.remove('hidden', 'opacity-0');
                    el.loadingSpinner.classList.add('opacity-100');
                } else {
                    el.loadingSpinner.classList.remove('opacity-100');
                    el.loadingSpinner.classList.add('opacity-0');
                    setTimeout(() => el.loadingSpinner.classList.add('hidden'), 300);
                }
            }
        }

        // --- Tab Management ---

        /**
         * Sets the active tab and displays the corresponding section.
         * @param {string} tabName - 'apply', 'view-teachers', or 'my-profile'.
         */
        function setActiveTab(tabName) {
            // Remove active class from all tabs
            el.applyTabButton?.classList.remove('tab-button-active');
            el.viewTeachersTabButton?.classList.remove('tab-button-active');
            el.myProfileTabButton?.classList.remove('tab-button-active');

            // Hide all sections
            el.teacherApplicationSection?.classList.add('hidden');
            el.teacherRosterSection?.classList.add('hidden');
            el.myProfileSection?.classList.add('hidden');

            // Set active tab and show relevant section
            if (tabName === 'apply') {
                el.applyTabButton?.classList.add('tab-button-active');
                el.teacherApplicationSection?.classList.remove('hidden');
                // Reset form to "Apply" state
                el.teacherProfileForm.reset();
                el.teacherDocIdInput.value = '';
                if(el.bioCharCount) el.bioCharCount.textContent = "0/1500";
                el.applicationFormTitle.textContent = "Trở thành Nhà giáo Quốc tế của IVS";
                el.applicationFormDescription.textContent = "Hoàn thành biểu mẫu dưới đây để mở khóa các cơ hội nghề nghiệp thú vị. Thông tin của bạn sẽ được lưu trữ an toàn.";
                el.submitProfileButton.innerHTML = '<i class="fas fa-save mr-2.5"></i>Lưu hồ sơ';
            } else if (tabName === 'view-teachers') {
                el.viewTeachersTabButton?.classList.add('tab-button-active');
                el.teacherRosterSection?.classList.remove('hidden');
                renderTeacherList(allTeachers); // Re-render the list when tab is active
            } else if (tabName === 'my-profile') {
                el.myProfileTabButton?.classList.add('tab-button-active');
                el.myProfileSection?.classList.remove('hidden');
                // Load and display current user's profile
                loadMyProfile();
            }
            AOS.refreshHard(); // Refresh AOS to ensure animations play correctly
        }

        // --- Firebase Initialization and Auth ---

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebase() {
            try {
                // Initialize Firebase app if not already initialized
                if (!app) {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // Sign in with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('Đăng nhập bằng token tùy chỉnh thành công.');
                } else {
                    await signInAnonymously(auth);
                    console.log('Đăng nhập ẩn danh thành công.');
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        el.currentUserIdSpan.textContent = currentUserId;
                        console.log('Người dùng đã đăng nhập:', currentUserId);
                        // Show "My Profile" tab once authenticated
                        el.myProfileTabButton.classList.remove('hidden');
                        // Start listening to the current user's profile data
                        listenToUserTeacherProfile(currentUserId);
                        // Start listening to all teachers data for the roster
                        listenToAllTeachers();
                    } else {
                        currentUserId = 'Không xác định';
                        el.currentUserIdSpan.textContent = currentUserId;
                        console.log('Người dùng đã đăng xuất hoặc chưa đăng nhập.');
                        // Hide "My Profile" tab if not authenticated
                        el.myProfileTabButton.classList.add('hidden');
                        // Stop Firestore listeners if user logs out
                        if (teacherProfileListener) teacherProfileListener();
                        if (teacherListListener) teacherListListener();
                        allTeachers = []; // Clear cached teachers
                        renderTeacherList([]); // Clear displayed teachers
                        // Redirect to apply tab if currently on my-profile
                        if (el.myProfileSection?.classList.contains('active')) {
                            setActiveTab('apply');
                        }
                    }
                    toggleLoadingSpinner(false); // Hide spinner once auth state is determined
                });

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase hoặc xác thực:", error);
                showAppModal("Lỗi Firebase", `Không thể kết nối dịch vụ. Vui lòng thử lại sau. Chi tiết: ${error.message}`, 'error');
                toggleLoadingSpinner(false);
            }
        }

        // --- Firestore Operations for Teacher Profiles ---

        /**
         * Saves a teacher profile to Firestore.
         * @param {object} teacherData - The data of the teacher.
         * @param {string} [docId] - Optional document ID for updating an existing profile.
         */
        async function saveTeacherProfile(teacherData, docId = null) {
            if (!db || !currentUserId || currentUserId === 'Đang tải...') {
                showAppModal("Lỗi", "Hệ thống chưa sẵn sàng. Vui lòng chờ hoặc đăng nhập lại.", 'error');
                return;
            }

            toggleLoadingSpinner(true);
            try {
                // Determine the base path for user-specific data
                const userTeachersCollectionPath = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/teachers`;
                const userTeacherDocRef = doc(db, userTeachersCollectionPath, currentUserId); // Always use UID as doc ID for user's profile

                // Determine the base path for public data
                const publicTeachersCollectionPath = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/teachers`;
                const publicTeacherDocRef = doc(db, publicTeachersCollectionPath, currentUserId); // Use UID as doc ID for public profile

                // Add userId to teacherData if it's not already there
                teacherData.userId = currentUserId;

                // Save to user's private collection
                await setDoc(userTeacherDocRef, teacherData, { merge: true }); // Use setDoc with merge to update fields
                // Save to public collection
                await setDoc(publicTeacherDocRef, teacherData, { merge: true });

                userTeacherDocId = currentUserId; // Ensure the ID is set for subsequent updates
                showAppModal("Thành công", "Hồ sơ của bạn đã được cập nhật thành công!", 'success', { showConfirm: true });
                
                el.teacherProfileForm.reset();
                if(el.bioCharCount) el.bioCharCount.textContent = "0/1500";
                setActiveTab('my-profile'); // Switch to my profile tab after save
            } catch (error) {
                console.error("Lỗi khi lưu hồ sơ giáo viên:", error);
                showAppModal("Lỗi", `Không thể lưu hồ sơ của bạn. Vui lòng thử lại. Chi tiết: ${error.message}`, 'error');
            } finally {
                toggleLoadingSpinner(false);
            }
        }

        /**
         * Loads the current user's teacher profile from Firestore and populates the form/display.
         */
        async function loadMyProfile() {
            if (!db || !currentUserId || currentUserId === 'Đang tải...') {
                console.log("Không thể tải hồ sơ: Firebase hoặc ID người dùng chưa sẵn sàng.");
                return;
            }

            toggleLoadingSpinner(true);
            try {
                const teacherDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/teachers`, currentUserId);
                const docSnap = await getDoc(teacherDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userTeacherDocId = docSnap.id; // Store the doc ID for updates

                    // Populate the form for editing
                    el.fullName.value = data.fullName || '';
                    el.email.value = data.email || '';
                    el.phoneNumber.value = data.phoneNumber || '';
                    el.nationality.value = data.nationality || '';
                    el.qualification.value = data.qualification || '';
                    el.experience.value = data.experience || '';
                    el.subjects.value = data.subjects || '';
                    el.bioTextarea.value = data.bio || '';
                    el.bioCharCount.textContent = `${el.bioTextarea.value.length}/1500`;
                    el.availability.value = data.availability || 'Available';
                    el.teacherDocIdInput.value = docSnap.id; // Set hidden input for doc ID

                    // Populate "My Profile" display section
                    el.myProfileDisplay.classList.remove('hidden');
                    el.noProfileMessage.classList.add('hidden');
                    el.profileFullName.textContent = data.fullName || 'N/A';
                    el.profileEmail.textContent = data.email || 'N/A';
                    el.profilePhone.textContent = data.phoneNumber || 'N/A';
                    el.profileNationality.textContent = data.nationality || 'N/A';
                    el.profileQualification.textContent = data.qualification || 'N/A';
                    el.profileExperience.textContent = data.experience !== undefined ? `${data.experience}` : 'N/A';
                    el.profileSubjects.textContent = data.subjects || 'N/A';
                    el.profileBio.textContent = data.bio || 'N/A';
                    el.profileAvailability.textContent = data.availability || 'N/A';

                    // Update form title and button for editing
                    el.applicationFormTitle.textContent = "Chỉnh sửa Hồ sơ Giáo viên của bạn";
                    el.applicationFormDescription.textContent = "Cập nhật thông tin hồ sơ của bạn. Mọi thay đổi sẽ được lưu tự động.";
                    el.submitProfileButton.innerHTML = '<i class="fas fa-sync-alt mr-2.5"></i>Cập nhật hồ sơ';

                } else {
                    console.log("Không tìm thấy hồ sơ giáo viên cho người dùng này.");
                    userTeacherDocId = null;
                    el.myProfileDisplay.classList.add('hidden');
                    el.noProfileMessage.classList.remove('hidden');
                    // Reset form to "apply" state if no profile found
                    el.teacherProfileForm.reset();
                    if(el.bioCharCount) el.bioCharCount.textContent = "0/1500";
                    el.teacherDocIdInput.value = '';
                    el.applicationFormTitle.textContent = "Trở thành Nhà giáo Quốc tế của IVS";
                    el.applicationFormDescription.textContent = "Hoàn thành biểu mẫu dưới đây để mở khóa các cơ hội nghề nghiệp thú vị. Thông tin của bạn sẽ được lưu trữ an toàn.";
                    el.submitProfileButton.innerHTML = '<i class="fas fa-save mr-2.5"></i>Lưu hồ sơ';
                }
            } catch (error) {
                console.error("Lỗi khi tải hồ sơ giáo viên:", error);
                showAppModal("Lỗi", `Không thể tải hồ sơ của bạn. Chi tiết: ${error.message}`, 'error');
            } finally {
                toggleLoadingSpinner(false);
            }
        }

        /**
         * Deletes the current user's teacher profile from Firestore.
         */
        async function deleteMyProfile() {
            if (!db || !currentUserId || currentUserId === 'Đang tải...') {
                showAppModal("Lỗi", "Hệ thống chưa sẵn sàng. Vui lòng chờ hoặc đăng nhập lại.", 'error');
                return;
            }
            if (!userTeacherDocId) {
                showAppModal("Lỗi", "Không có hồ sơ để xóa.", 'warning');
                return;
            }

            showAppModal(
                "Xác nhận xóa",
                "Bạn có chắc chắn muốn xóa hồ sơ giáo viên của mình không? Hành động này không thể hoàn tác.",
                "warning",
                {
                    showConfirm: true,
                    confirmText: "Xóa",
                    onConfirm: async () => {
                        toggleLoadingSpinner(true);
                        try {
                            const userTeacherDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/teachers`, userTeacherDocId);
                            const publicTeacherDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/teachers`, userTeacherDocId);

                            await deleteDoc(userTeacherDocRef);
                            await deleteDoc(publicTeacherDocRef); // Delete from public collection as well

                            userTeacherDocId = null; // Clear the stored doc ID
                            el.teacherProfileForm.reset(); // Clear the form
                            if(el.bioCharCount) el.bioCharCount.textContent = "0/1500";
                            showAppModal("Thành công", "Hồ sơ của bạn đã được xóa thành công.", 'success', { showConfirm: true });
                            setActiveTab('apply'); // Redirect to apply tab
                        } catch (error) {
                            console.error("Lỗi khi xóa hồ sơ:", error);
                            showAppModal("Lỗi", `Không thể xóa hồ sơ của bạn. Chi tiết: ${error.message}`, 'error');
                        } finally {
                            toggleLoadingSpinner(false);
                        }
                    },
                    showCancel: true,
                    cancelText: "Không xóa"
                }
            );
        }

        /**
         * Sets up a real-time listener for the current user's teacher profile.
         * This ensures 'My Profile' tab is always up-to-date.
         * @param {string} uid - The current user's Firebase UID.
         */
        function listenToUserTeacherProfile(uid) {
            if (teacherProfileListener) {
                teacherProfileListener(); // Unsubscribe from previous listener if exists
            }
            if (!db) return; // Ensure db is initialized

            const docRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${uid}/teachers`, uid);
            teacherProfileListener = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userTeacherDocId = docSnap.id;
                    // Only update the form/display if the 'My Profile' tab is active
                    if (el.myProfileSection && !el.myProfileSection.classList.contains('hidden')) {
                        // Populate "My Profile" display section
                        el.myProfileDisplay.classList.remove('hidden');
                        el.noProfileMessage.classList.add('hidden');
                        el.profileFullName.textContent = data.fullName || 'N/A';
                        el.profileEmail.textContent = data.email || 'N/A';
                        el.profilePhone.textContent = data.phoneNumber || 'N/A';
                        el.profileNationality.textContent = data.nationality || 'N/A';
                        el.profileQualification.textContent = data.qualification || 'N/A';
                        el.profileExperience.textContent = data.experience !== undefined ? `${data.experience}` : 'N/A';
                        el.profileSubjects.textContent = data.subjects || 'N/A';
                        el.profileBio.textContent = data.bio || 'N/A';
                        el.profileAvailability.textContent = data.availability || 'N/A';

                        // Populate the form if user is editing their profile in apply tab
                        if (el.teacherApplicationSection && !el.teacherApplicationSection.classList.contains('hidden') && el.teacherDocIdInput.value === userTeacherDocId) {
                            el.fullName.value = data.fullName || '';
                            el.email.value = data.email || '';
                            el.phoneNumber.value = data.phoneNumber || '';
                            el.nationality.value = data.nationality || '';
                            el.qualification.value = data.qualification || '';
                            el.experience.value = data.experience || '';
                            el.subjects.value = data.subjects || '';
                            el.bioTextarea.value = data.bio || '';
                            el.bioCharCount.textContent = `${el.bioTextarea.value.length}/1500`;
                            el.availability.value = data.availability || 'Available';
                            el.teacherDocIdInput.value = docSnap.id;
                        }

                        // Update form title and button for editing
                        el.applicationFormTitle.textContent = "Chỉnh sửa Hồ sơ Giáo viên của bạn";
                        el.applicationFormDescription.textContent = "Cập nhật thông tin hồ sơ của bạn. Mọi thay đổi sẽ được lưu tự động.";
                        el.submitProfileButton.innerHTML = '<i class="fas fa-sync-alt mr-2.5"></i>Cập nhật hồ sơ';
                    }
                } else {
                    userTeacherDocId = null;
                    if (el.myProfileSection && !el.myProfileSection.classList.contains('hidden')) {
                        el.myProfileDisplay.classList.add('hidden');
                        el.noProfileMessage.classList.remove('hidden');
                    }
                    // Reset form to "apply" state if profile is deleted externally
                    el.teacherProfileForm.reset();
                    if(el.bioCharCount) el.bioCharCount.textContent = "0/1500";
                    el.teacherDocIdInput.value = '';
                    el.applicationFormTitle.textContent = "Trở thành Nhà giáo Quốc tế của IVS";
                    el.applicationFormDescription.textContent = "Hoàn thành biểu mẫu dưới đây để mở khóa các cơ hội nghề nghiệp thú vị. Thông tin của bạn sẽ được lưu trữ an toàn.";
                    el.submitProfileButton.innerHTML = '<i class="fas fa-save mr-2.5"></i>Lưu hồ sơ';
                }
            }, (error) => {
                console.error("Lỗi khi lắng nghe hồ sơ giáo viên:", error);
                // Optionally show an error modal
            });
        }

        /**
         * Sets up a real-time listener for all teacher profiles in the public collection.
         */
        function listenToAllTeachers() {
            if (teacherListListener) {
                teacherListListener(); // Unsubscribe from previous listener if exists
            }
            if (!db) return; // Ensure db is initialized

            // Assuming a 'public' collection for all teachers visible to everyone
            const teachersPublicCollectionRef = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/teachers`);

            teacherListListener = onSnapshot(teachersPublicCollectionRef, (snapshot) => {
                const teachers = [];
                const subjects = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Exclude any incomplete profiles or profiles from other apps if needed, though security rules handle user-specific data
                    if (data.fullName && data.subjects) {
                        teachers.push({ id: doc.id, ...data });
                        data.subjects.split(',').map(s => s.trim()).filter(s => s).forEach(s => subjects.add(s));
                    }
                });
                allTeachers = teachers; // Cache all teachers
                populateSubjectFilter(Array.from(subjects));
                renderTeacherList(allTeachers); // Initial render and re-render on changes
            }, (error) => {
                console.error("Lỗi khi lắng nghe danh sách giáo viên:", error);
                showAppModal("Lỗi tải danh sách", `Không thể tải danh sách giáo viên. Chi tiết: ${error.message}`, 'error');
            });
        }

        /**
         * Renders the list of teachers based on current filters and search query.
         * @param {Array} teachersToRender - The list of teacher objects to render.
         */
        function renderTeacherList(teachersToRender) {
            el.teacherListContainer.innerHTML = ''; // Clear previous cards
            el.noTeachersMessage.classList.add('hidden'); // Hide no results message by default

            const searchQuery = el.teacherSearch.value.toLowerCase();
            const filterSubject = el.teacherFilterSubject.value.toLowerCase();
            const filterAvailability = el.teacherFilterAvailability.value;

            // Apply filters
            const filteredTeachers = teachersToRender.filter(teacher => {
                const matchesSearch = 
                    (teacher.fullName && teacher.fullName.toLowerCase().includes(searchQuery)) ||
                    (teacher.nationality && teacher.nationality.toLowerCase().includes(searchQuery)) ||
                    (teacher.subjects && teacher.subjects.toLowerCase().includes(searchQuery)) ||
                    (teacher.qualification && teacher.qualification.toLowerCase().includes(searchQuery));

                const matchesSubject = filterSubject === '' || (teacher.subjects && teacher.subjects.toLowerCase().includes(filterSubject));
                const matchesAvailability = filterAvailability === '' || teacher.availability === filterAvailability;

                return matchesSearch && matchesSubject && matchesAvailability;
            });

            if (filteredTeachers.length === 0) {
                el.noTeachersMessage.classList.remove('hidden');
                return;
            }

            // Create and append teacher cards
            filteredTeachers.forEach(teacher => {
                const teacherCard = document.createElement('div');
                teacherCard.className = 'bg-white dark:bg-ivs-neutral-800 rounded-xl shadow-lg p-6 border border-ivs-neutral-200 dark:border-ivs-neutral-700 hover:shadow-xl transition-all duration-200 ease-in-out transform hover:-translate-y-1';
                teacherCard.innerHTML = `
                    <h3 class="text-xl font-display font-semibold text-ivs-primary dark:text-ivs-secondary mb-2">${teacher.fullName || 'N/A'}</h3>
                    <p class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-400 mb-1">
                        <i class="fas fa-envelope mr-2"></i>${teacher.email || 'N/A'}
                    </p>
                    <p class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-400 mb-1">
                        <i class="fas fa-phone mr-2"></i>${teacher.phoneNumber || 'N/A'}
                    </p>
                    <p class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-400 mb-1">
                        <i class="fas fa-globe mr-2"></i>Quốc tịch: ${teacher.nationality || 'N/A'}
                    </p>
                    <p class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-400 mb-1">
                        <i class="fas fa-graduation-cap mr-2"></i>Bằng cấp: ${teacher.qualification || 'N/A'}
                    </p>
                    <p class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-400 mb-1">
                        <i class="fas fa-briefcase mr-2"></i>Kinh nghiệm: ${teacher.experience !== undefined ? `${teacher.experience}` : 'N/A'} năm
                    </p>
                    <p class="text-sm text-ivs-neutral-600 dark:text-ivs-neutral-400 mb-3">
                        <i class="fas fa-book mr-2"></i>Môn dạy: ${teacher.subjects || 'N/A'}
                    </p>
                    <p class="text-xs text-ivs-neutral-500 dark:text-ivs-neutral-300 line-clamp-3 mb-3">
                        ${teacher.bio || 'N/A'}
                    </p>
                    <div class="text-sm font-medium ${teacher.availability === 'Available' ? 'text-ivs-success' : teacher.availability === 'Limited Availability' ? 'text-ivs-warning' : teacher.availability === 'Not Available' ? 'text-ivs-danger' : 'text-ivs-neutral-500'}">
                        Tình trạng: ${teacher.availability || 'N/A'}
                    </div>
                `;
                el.teacherListContainer.appendChild(teacherCard);
            });
        }

        /**
         * Populates the subject filter dropdown with unique subjects from all teachers.
         * @param {Array<string>} subjects - Array of unique subjects.
         */
        function populateSubjectFilter(subjects) {
            el.teacherFilterSubject.innerHTML = '<option value="">Tất cả môn học</option>'; // Always have default option
            subjects.sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.toLowerCase();
                option.textContent = subject;
                el.teacherFilterSubject.appendChild(option);
            });
        }

        // --- Event Listeners and Initial Setup ---

        // Modal close button
        if (el.modalCloseButtonX) el.modalCloseButtonX.addEventListener('click', hideAppModal);

        // Bio textarea character count
        if (el.bioTextarea && el.bioCharCount) {
            el.bioTextarea.addEventListener('input', () => {
                const maxLength = parseInt(el.bioTextarea.getAttribute('maxlength')) || 1500;
                el.bioCharCount.textContent = `${el.bioTextarea.value.length}/${maxLength}`;
            });
        }
        
        // Tab click handlers
        el.applyTabButton?.addEventListener('click', () => setActiveTab('apply'));
        el.viewTeachersTabButton?.addEventListener('click', () => setActiveTab('view-teachers'));
        el.myProfileTabButton?.addEventListener('click', () => setActiveTab('my-profile'));

        // Form submission handler
        el.teacherProfileForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherData = {
                fullName: el.fullName.value.trim(),
                email: el.email.value.trim(),
                phoneNumber: el.phoneNumber.value.trim(),
                nationality: el.nationality.value.trim(),
                qualification: el.qualification.value.trim(),
                experience: Number(el.experience.value),
                subjects: el.subjects.value.trim(),
                bio: el.bioTextarea.value.trim(),
                availability: el.availability.value
            };
            await saveTeacherProfile(teacherData, el.teacherDocIdInput.value || null);
        });

        // Edit My Profile button handler
        el.editMyProfileButton?.addEventListener('click', () => {
            // Switch to apply tab to edit the profile
            setActiveTab('apply');
            // Re-populate the form with current user's profile data
            loadMyProfile(); 
        });

        // Delete My Profile button handler
        el.deleteMyProfileButton?.addEventListener('click', deleteMyProfile);

        // Search and filter input event listeners
        el.teacherSearch?.addEventListener('input', () => renderTeacherList(allTeachers));
        el.teacherFilterSubject?.addEventListener('change', () => renderTeacherList(allTeachers));
        el.teacherFilterAvailability?.addEventListener('change', () => renderTeacherList(allTeachers));

        /**
         * Initializes AOS and sets the initial active tab.
         */
        function initializeAppCore() {
            AOS.init({ duration: 700, once: true, offset: 30, easing: 'ease-out-cubic' });
            // The initial tab will be "Apply Now" (Teacher Application)
            setActiveTab('apply'); 
            toggleLoadingSpinner(false); 
        }
        
        // Callback executed after common components (header, footer, language) are loaded
        window.onPageComponentsLoadedCallback = async () => { // Make this function async
            // Initialize language system and apply translations
            if (window.langSystem && window.langSystem.initialized) {
                if (typeof window.applyTranslations === 'function') {
                    window.applyTranslations(document.body); 
                }
            }
            // Initialize Firebase and core app logic
            await initializeFirebase();
            initializeAppCore(); 
            window.pageComponentsCallbackCalled = true; 
        };

        // Fallback for DOMContentLoaded if pageComponentsLoadedCallback isn't called in time
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(async () => { // Make the callback function async
                if (!window.pageComponentsCallbackCalled) { 
                    if (typeof window.initializeLanguageSystem === 'function') {
                        try {
                            await window.initializeLanguageSystem('en'); // Await this call
                            if (typeof window.applyTranslations === 'function') {
                                window.applyTranslations(document.body);
                            }
                            await initializeFirebase(); // Await this call
                            initializeAppCore();
                        } catch (err) {
                            console.error("Lỗi khởi tạo hệ thống ngôn ngữ:", err);
                            await initializeFirebase(); // Still try to initialize Firebase, await this call
                            initializeAppCore(); 
                        }
                    } else {
                         // If language system is not available, proceed with core app init
                         await initializeFirebase(); // Await this call
                         initializeAppCore(); 
                    }
                }
            }, 1500); // Give some time for loadComponents.js to call the callback
        });
    </script>
</body>
</html>
